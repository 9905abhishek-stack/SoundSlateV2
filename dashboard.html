<!DOCTYPE html>
<html lang="en" class="h-full"> <!-- Defaulted to Light Theme (no 'dark' class initially) -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoundSlate - Dashboards</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">

    <!-- Use v5.5.2 for solid icons --><script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

    <script>
        // Configure Tailwind for dark mode and custom colors
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
            theme: {
                extend: {
                    colors: {
                        'accent': '#38BDF8', // sky-400
                        'accent-dark': '#0EA5E9', // sky-500
                        'bg-light': '#F9FAFB', // gray-50
                        // Dark mode colors (defined via CSS variables below for easier JS toggle)
                    }
                }
            }
        }
    </script>

    <style>
        /* Light mode variables (default) */
        :root {
            --bg-primary: #F9FAFB; /* bg-light / gray-50 */
            --bg-secondary: #ffffff; /* white */
            --bg-tertiary: #F3F4F6; /* gray-100 */
            --bg-muted: #E5E7EB; /* gray-200 */
            --text-primary: #111827; /* gray-900 */
            --text-secondary: #374151; /* gray-700 */
            --text-muted: #6B7280; /* gray-500 */
            --border-color: #E5E7EB; /* gray-200 */
            --accent: #38BDF8;
            --accent-dark: #0EA5E9;
            --accent-contrast: #ffffff;
            --icon-color: #6B7280; /* gray-500 */
            --icon-hover-bg: var(--accent);
            --icon-hover-text: #ffffff;
            --chart-grid-color: rgba(0, 0, 0, 0.1);
        }

        /* Dark mode variables */
        .dark {
            --bg-primary: #0f172a; /* slate-900 */
            --bg-secondary: #1e293b; /* slate-800 */
            --bg-tertiary: #334155; /* slate-700 */
            --bg-muted: #475569; /* slate-600 */
            --text-primary: #f8fafc; /* slate-50 */
            --text-secondary: #cbd5e1; /* slate-300 */
            --text-muted: #94a3b8; /* slate-400 */
            --border-color: #475569; /* slate-600 */
            --accent: #38BDF8; /* sky-400 */
            --accent-dark: #7dd3fc; /* sky-300 */
            --accent-contrast: #0f172a; /* slate-900 for text on accent */
            --icon-color: #94a3b8; /* slate-400 */
            --icon-hover-bg: var(--accent);
            --icon-hover-text: #0f172a; /* slate-900 */
            --chart-grid-color: rgba(255, 255, 255, 0.1);
        }

        /* Apply variables */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        header { background-color: var(--bg-secondary); border-bottom-color: var(--border-color); }
        main { background-color: var(--bg-primary); }
        .bg-white { background-color: var(--bg-secondary); }
        .bg-gray-50 { background-color: var(--bg-tertiary); }
        .bg-gray-100 { background-color: var(--bg-tertiary); } /* Re-map gray-100 */
        .bg-gray-200 { background-color: var(--bg-muted); }
        .text-gray-900 { color: var(--text-primary); }
        .text-gray-800 { color: var(--text-primary); } /* Re-map gray-800 */
        .text-gray-700 { color: var(--text-secondary); }
        .text-gray-600 { color: var(--text-muted); }
        .text-gray-500 { color: var(--icon-color); }
        .text-accent { color: var(--accent); }
        .hover\:text-accent-dark:hover { color: var(--accent-dark); }
        .bg-accent { background-color: var(--accent); color: var(--accent-contrast); }
        .hover\:bg-accent-dark:hover { background-color: var(--accent-dark); color: var(--accent-contrast); }
        .border, .border-t, .border-b, .border-l, .border-r { border-color: var(--border-color); }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .dark .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2); } /* Darker shadow */
        .hover\:bg-gray-100:hover { background-color: var(--bg-tertiary); }
        .hover\:text-gray-900:hover { color: var(--text-primary); }
        input, select, textarea { background-color: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color); }
        input::placeholder, textarea::placeholder { color: var(--text-muted); }

        /* DARK MODE FIX: Ensure select options are legible in the reports dropdowns */
        .dark select option {
            background-color: var(--bg-secondary); /* Dark background for dropdown options */
            color: var(--text-primary);           /* Light text for dropdown options */
        }
        
        /* Icon specific hover styles */
        .text-gray-500.hover\:text-white:hover { color: var(--icon-hover-text); }
        .hover\:bg-accent:hover { background-color: var(--icon-hover-bg); }


        .page { display: none; }
        .page.active { display: block; }

        /* Toast Notification styles */
        .toast-notification {
            @apply fixed top-5 right-5 bg-blue-600 text-white px-6 py-4 rounded-lg shadow-xl z-[100] transform translate-x-full transition-transform duration-300 ease-out;
        }
        .toast-notification.show { @apply translate-x-0; }

        /* Chat Bubble styles */
        .chat-bubble { @apply px-4 py-2 rounded-lg max-w-xs; }
        .chat-bubble-user { @apply bg-accent text-white self-end rounded-br-none; color: var(--accent-contrast); }
        .chat-bubble-ai { background-color: var(--bg-muted); color: var(--text-secondary); @apply self-start rounded-bl-none; }
        .chat-bubble-ai.thinking { @apply italic; color: var(--text-muted); }

        /* Chart Legend */
        .chart-legend-item { @apply flex items-center text-sm; color: var(--text-muted); }
        .chart-legend-dot { @apply w-3 h-3 rounded-full mr-2; }

        /* Starry backgrounds remain the same */
        .bg-starry-gradient { background-image: linear-gradient(to right, #2c3e50, #000000); }
        .bg-starry-night { background-image: url('https://images.unsplash.com/photo-1502134249126-9f3755a50d78?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8fHx8fA%3D%3D'); background-size: cover; background-position: center; }
        /* New background for active nav tabs */
        .bg-active-nav-sky { background-image: url('https://images.unsplash.com/photo-1532178910-7815d6919875?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8fHx8fA%3D%3D'); background-size: cover; background-position: center; }

        /* Nav links */
        .nav-link.active { @apply bg-active-nav-sky text-white rounded-lg shadow-md; background-size: cover; background-position: center; text-shadow: 0 0 6px rgba(0, 0, 0, 0.3); }
        .nav-link.inactive { color: var(--text-muted); }
        .nav-link.inactive:hover { background-color: var(--bg-tertiary); color: var(--text-primary); }


        /* Logo styles */
        .logo-container { display: flex; align-items: center; gap: 0.5rem; }
        /* Increased font weight for the S to be 'sleeky skype bold' */
        .soundslate-logo-text { display: inline-block; font-size: 1.5rem; line-height: 2rem; font-weight: 800; color: var(--accent); vertical-align: middle; }
        /* Style for active mode button */
        .toggle-button.active { @apply bg-accent text-white shadow-md; }
        .toggle-button.inactive { background-color: var(--bg-muted); color: var(--text-secondary); }

        /* File Input & Recording */
        .file-input-button { @apply inline-flex items-center justify-center gap-2 px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium bg-white hover:bg-gray-50 cursor-pointer; color: var(--text-secondary); background-color: var(--bg-secondary); border-color: var(--border-color); }
        .file-input-button:hover { background-color: var(--bg-tertiary); }
        .recording-dot { @apply w-3 h-3 rounded-full bg-red-500 animate-pulse; }

        /* Notification Badge & Dropdown */
        .notification-badge-container { @apply relative; }
        .notification-badge { @apply absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white; }
        /* A default style for all notification modals to ensure theme colors are used */
        #notification-modal .bg-white { background-color: var(--bg-secondary); }
        #notification-modal .border-b { border-color: var(--border-color); }
        #notification-modal .text-gray-900 { color: var(--text-primary); }
        #notification-modal .text-gray-600 { color: var(--text-muted); }
        #notification-modal .bg-gray-50 { background-color: var(--bg-tertiary); }
        #notification-modal .hover\:bg-gray-100:hover { background-color: var(--bg-muted); }

        /* Report Modal Wrapping */
        #report-content { white-space: normal; word-wrap: break-word; overflow-wrap: break-word; }
        #report-content p, #report-content li, #report-content strong, #report-content em { white-space: normal; word-wrap: break-word; overflow-wrap: break-word; }
        /* Markdown generated content styles */
        #generated-content-results h1, #generated-content-results h2, #generated-content-results h3 { color: var(--text-primary); margin-bottom: 0.5rem; font-weight: 600; }
        #generated-content-results p { color: var(--text-secondary); margin-bottom: 1rem; }
        #generated-content-results ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 1rem; color: var(--text-secondary); }
        #generated-content-results li { margin-bottom: 0.5rem; }


        /* Theme Toggle Switch */
        .theme-switch-wrapper { @apply flex items-center; }
        .theme-switch { @apply relative inline-block w-12 h-6 cursor-pointer; } /* Increased width to 12 */
        .theme-switch input { @apply opacity-0 w-0 h-0; }
        .slider { 
            @apply absolute top-0 left-0 right-0 bottom-0 rounded-full transition duration-300; 
            background-color: var(--bg-muted); 
            box-shadow: inset 0 0 4px rgba(0,0,0,0.2);
        }
        .slider:before { 
            @apply absolute content-[''] h-4 w-4 left-1 bottom-1 rounded-full transition duration-300; 
            background-color: white; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }
        /* Style for the sun icon */
        .slider ion-icon.sun {
            @apply absolute text-yellow-500 w-4 h-4;
            top: 5px;
            right: 4px;
            transition: opacity 0.2s;
        }
         /* Style for the moon icon */
        .slider ion-icon.moon {
            @apply absolute text-sky-200 w-4 h-4;
            top: 5px;
            left: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        /* CHECKED STATE */
        input:checked + .slider { 
            background-color: var(--accent); 
        }
        input:checked + .slider:before { 
            @apply transform translate-x-6; /* Pushed further right */
        }
        input:checked + .slider ion-icon.sun {
            opacity: 0;
        }
        input:checked + .slider ion-icon.moon {
            opacity: 1;
        }

        /* Checkbox theming */
        input[type="checkbox"] { 
            border-color: var(--border-color); 
            background-color: var(--bg-secondary); 
        }
        input[type="checkbox"]:checked { 
            background-color: var(--accent); 
            border-color: var(--accent); 
        }

    </style>
</head>
<body class="min-h-full"> <!-- Body class controlled by JS -->

    <!-- PAGE 1: HOME DASHBOARD -->
    <div id="page-home" class="page active">
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo and Nav -->
                    <div class="flex items-center space-x-4">
                        <div class="logo-container">
                            <!-- Logo for SoundSlate: Sleek 'S' in a rounded box -->
                            <div class="w-6 h-6 rounded-md flex items-center justify-center font-black text-white" style="background-color: var(--accent); font-size: 1.25rem; line-height: 1;">S</div>
                            <div class="soundslate-logo-text">SOUNDSLATE</div>
                        </div>
                        <nav class="hidden md:flex space-x-2">
                            <a href="#" onclick="navigateTo('page-home')" data-page="page-home" class="nav-link active flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="home-outline" class="text-xl"></ion-icon> Home </a>
                            <a href="#" onclick="navigateTo('page-progress')" data-page="page-progress" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="stats-chart-outline" class="text-xl"></ion-icon> Progress </a>
                            <a href="#" onclick="navigateTo('page-insights')" data-page="page-insights" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="bulb-outline" class="text-xl"></ion-icon> Insights </a>
                            <a href="#" onclick="navigateTo('page-generator')" data-page="page-generator" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="sparkles-outline" class="text-xl"></ion-icon> AI Content </a>
                            <a href="#" onclick="navigateTo('page-reports')" data-page="page-reports" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="document-text-outline" class="text-xl"></ion-icon> Reports </a>
                            <a href="#" onclick="navigateTo('page-assessment')" data-page="page-assessment" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="play-outline" class="text-xl"></ion-icon> Assessment </a>
                        </nav>
                    </div>
                    <!-- User Menu and Icons -->
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <div id="user-avatar-home" class="w-8 h-8 rounded-full bg-starry-night text-white flex items-center justify-center font-semibold bg-cover bg-center">A</div>
                            <span id="user-name-home" class="hidden md:block text-sm font-medium text-gray-700">Hi, Abhishek!</span>
                        </div>
                        <div class="flex items-center space-x-1 relative"> <!-- Added relative for dropdown positioning -->
                            <!-- Notification Button - opens modal via JS -->
                            <button onclick="toggleNotificationDropdown(event)" class="notification-badge-container text-gray-500 hover:text-white hover:bg-accent p-2 rounded-full transition-all duration-200" title="Notifications">
                                <ion-icon name="notifications-outline" class="text-2xl"></ion-icon>
                                <span class="notification-badge"></span>
                            </button>
                            <!-- NOTE: Notification Dropdown HTML is removed from here -->
                            <button onclick="navigateTo('page-settings')" class="text-gray-500 hover:text-white hover:bg-accent p-2 rounded-full transition-all duration-200" title="Settings"> <ion-icon name="settings-outline" class="text-2xl"></ion-icon> </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">
                <!-- Welcome Banner -->
                <div class="relative bg-starry-night text-white p-6 md:p-8 rounded-xl shadow-md mb-8 flex flex-col md:flex-row justify-between items-center overflow-hidden">
                    <div class="absolute inset-0 bg-black opacity-40 z-0"></div>
                    <div class="relative z-10 mb-4 md:mb-0">
                        <h1 id="welcome-banner" class="text-3xl font-bold">Welcome back, Abhishek!</h1>
                        <p class="mt-1 text-lg text-sky-100">Track your child's learning journey with powerful insights.</p>
                    </div>
                    <div class="relative z-10 flex flex-col sm:flex-row gap-3">
                        <button onclick="navigateTo('page-progress')" class="bg-accent text-white font-semibold px-5 py-3 rounded-lg shadow-md hover:bg-accent-dark transition duration-200 flex items-center justify-center gap-2"> <ion-icon name="bar-chart-outline" class="text-xl"></ion-icon> View Dashboard </button>
                        <button onclick="navigateTo('page-assessment')" class="bg-white/20 text-white border-2 border-white font-semibold px-5 py-3 rounded-lg shadow-md hover:bg-white/30 transition duration-200 flex items-center justify-center gap-2"> <ion-icon name="play-outline" class="text-xl"></ion-icon> Start Assessment </button>
                    </div>
                </div>

                <!-- Stat Cards -->
                <h2 class="text-2xl font-semibold text-gray-900 mb-4">Your Child's Progress Overview </h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Cards remain here -->
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4"> <div class="p-3 rounded-full bg-sky-100 text-sky-600"><ion-icon name="checkmark-done-circle-outline" class="text-3xl"></ion-icon></div> <div><div class="text-3xl font-bold text-gray-900">27</div><div class="text-sm text-gray-500">Tasks Completed</div></div> </div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4"> <div class="p-3 rounded-full bg-sky-100 text-sky-600"><ion-icon name="time-outline" class="text-3xl"></ion-icon></div> <div><div class="text-3xl font-bold text-gray-900">2.5h</div><div class="text-sm text-gray-500">Study Time Today</div></div> </div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4"> <div class="p-3 rounded-full bg-sky-100 text-sky-600"><ion-icon name="trending-up-outline" class="text-3xl"></ion-icon></div> <div><div class="text-3xl font-bold text-gray-900">85%</div><div class="text-sm text-gray-500">Success Rate</div></div> </div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4"> <div class="p-3 rounded-full bg-green-100 text-green-600"><ion-icon name="arrow-up-circle-outline" class="text-3xl"></ion-icon></div> <div><div class="text-3xl font-bold text-green-600">+12%</div><div class="text-sm text-gray-500">Weekly Improvement</div></div> </div>
                </div>
                
                <!-- New Grid for Features and Notifications -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- 1. Key Features (lg:col-span-2) -->
                    <div class="lg:col-span-2">
                        <h2 class="text-2xl font-semibold text-gray-900 mb-4">Key Features</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Feature Cards... (content unchanged) -->
                            <div class="bg-white p-6 rounded-xl shadow-md"> <div class="p-3 rounded-full bg-sky-100 text-sky-600 w-12 h-12 flex items-center justify-center mb-3"><ion-icon name="analytics-outline" class="text-3xl"></ion-icon></div> <h3 class="text-lg font-semibold text-gray-900 mb-1">Real-time Tracking</h3> <p class="text-gray-600 text-sm">Monitor progress with live updates.</p> </div>
                            <div class="bg-white p-6 rounded-xl shadow-md"> <div class="p-3 rounded-full bg-sky-100 text-sky-600 w-12 h-12 flex items-center justify-center mb-3"><ion-icon name="alert-circle-outline" class="text-3xl"></ion-icon></div> <h3 class="text-lg font-semibold text-gray-900 mb-1">Early Warnings</h3> <p class="text-gray-600 text-sm">Get alerts for specific struggles.</p> </div>
                            <div class="bg-white p-6 rounded-xl shadow-md"> <div class="p-3 rounded-full bg-sky-100 text-sky-600 w-12 h-12 flex items-center justify-center mb-3"><ion-icon name="bulb-outline" class="text-3xl"></ion-icon></div> <h3 class="text-lg font-semibold text-gray-900 mb-1">AI Insights</h3> <p class="text-gray-600 text-sm">Receive personalized recommendations.</p> </div>
                            <div class="bg-white p-6 rounded-xl shadow-md"> <div class="p-3 rounded-full bg-sky-100 text-sky-600 w-12 h-12 flex items-center justify-center mb-3"><ion-icon name="people-outline" class="text-3xl"></ion-icon></div> <h3 class="text-lg font-semibold text-gray-900 mb-1">Teacher Connect</h3> <p class="text-gray-600 text-sm">Direct communication channel.</p> </div>
                            <div class="bg-white p-6 rounded-xl shadow-md"> <div class="p-3 rounded-full bg-sky-100 text-sky-600 w-12 h-12 flex items-center justify-center mb-3"><ion-icon name="phone-portrait-outline" class="text-3xl"></ion-icon></div> <h3 class="text-lg font-semibold text-gray-900 mb-1">Mobile Access</h3> <p class="text-gray-600 text-sm">Stay connected anywhere.</p> </div>
                            <div class="bg-white p-6 rounded-xl shadow-md"> <div class="p-3 rounded-full bg-sky-100 text-sky-600 w-12 h-12 flex items-center justify-center mb-3"><ion-icon name="document-text-outline" class="text-3xl"></ion-icon></div> <h3 class="text-lg font-semibold text-gray-900 mb-1">Detailed Reports</h3> <p class="text-gray-600 text-sm">Generate comprehensive reports.</p> </div>
                        </div>
                    </div>
                    
                    <!-- 2. Recent Notifications (lg:col-span-1) -->
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-900 mb-4">Recent Notifications</h2>
                        <div class="bg-white p-6 rounded-xl shadow-md h-full flex flex-col justify-between">
                            <ul class="space-y-4">
                                <li class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <ion-icon name="trending-up-outline" class="text-xl text-green-600 mt-1 flex-shrink-0"></ion-icon>
                                    <div>
                                        <p class="font-medium text-gray-900">Reading speed increased!</p>
                                        <p class="text-xs text-gray-600">Akash is now reading at 88 WPM. 2h ago</p>
                                    </div>
                                </li>
                                <li onclick="navigateTo('page-reports')" class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
                                    <ion-icon name="document-text-outline" class="text-xl text-blue-600 flex-shrink-0 mt-1"></ion-icon>
                                    <div>
                                        <p class="font-medium text-gray-900">New weekly report available.</p>
                                        <p class="text-xs text-gray-600">Summary for Oct 19-25 is ready. Yesterday</p>
                                    </div>
                                </li>
                                <li onclick="navigateTo('page-insights')" class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
                                    <ion-icon name="bulb-outline" class="text-xl text-yellow-600 flex-shrink-0 mt-1"></ion-icon>
                                    <div>
                                        <p class="font-medium text-gray-900">Focus Area: Complex Words</p>
                                        <p class="text-xs text-gray-600">AI suggests practice. 3d ago</p>
                                    </div>
                                </li>
                            </ul>
                            <button onclick="document.getElementById('notification-modal').classList.remove('hidden')" class="w-full text-sm font-semibold text-accent hover:underline mt-4 py-2 border-t pt-4 border-gray-200">View All Notifications</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- PAGE 2: PROGRESS DASHBOARD -->
    <div id="page-progress" class="page">
        <!-- Header updated -->
        <header class="bg-white shadow-sm sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <div class="logo-container">
                            <!-- Logo for SoundSlate: Sleek 'S' in a rounded box -->
                            <div class="w-6 h-6 rounded-md flex items-center justify-center font-black text-white" style="background-color: var(--accent); font-size: 1.25rem; line-height: 1;">S</div>
                            <div class="soundslate-logo-text">SOUNDSLATE</div>
                        </div>
                        <nav class="hidden md:flex space-x-2">
                            <a href="#" onclick="navigateTo('page-home')" data-page="page-home" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="home-outline" class="text-xl"></ion-icon> Home </a>
                            <a href="#" onclick="navigateTo('page-progress')" data-page="page-progress" class="nav-link active flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="stats-chart-outline" class="text-xl"></ion-icon> Progress </a>
                            <a href="#" onclick="navigateTo('page-insights')" data-page="page-insights" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="bulb-outline" class="text-xl"></ion-icon> Insights </a>
                            <a href="#" onclick="navigateTo('page-generator')" data-page="page-generator" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="sparkles-outline" class="text-xl"></ion-icon> AI Content </a>
                            <a href="#" onclick="navigateTo('page-reports')" data-page="page-reports" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="document-text-outline" class="text-xl"></ion-icon> Reports </a>
                            <a href="#" onclick="navigateTo('page-assessment')" data-page="page-assessment" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="play-outline" class="text-xl"></ion-icon> Assessment </a>
                        </nav>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2"> <div id="user-avatar-progress" class="w-8 h-8 rounded-full bg-starry-night text-white flex items-center justify-center font-semibold bg-cover bg-center">A</div> <span id="user-name-progress" class="hidden md:block text-sm font-medium text-gray-700">Hi, Abhishek!</span> </div>
                        <div class="flex items-center space-x-1 relative">
                            <!-- Notification Button - opens modal via JS -->
                            <button onclick="toggleNotificationDropdown(event)" class="notification-badge-container text-gray-500 hover:text-white hover:bg-accent p-2 rounded-full transition-all duration-200" title="Notifications"> <ion-icon name="notifications-outline" class="text-2xl"></ion-icon> <span class="notification-badge"></span> </button>
                            <!-- NOTE: Notification Dropdown HTML is removed from here -->
                            <button onclick="navigateTo('page-settings')" class="text-gray-500 hover:text-white hover:bg-accent p-2 rounded-full transition-all duration-200" title="Settings"> <ion-icon name="settings-outline" class="text-2xl"></ion-icon> </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Sub-Header Banner (content unchanged) -->
            <div class="bg-starry-gradient text-white"> <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-col md:flex-row justify-between items-center"> <div> <h1 id="progress-welcome" class="text-2xl font-bold">Hi Abhishek!</h1> <p class="text-sm text-sky-100">Let's check your child's reading & comprehension progress.</p> </div> <div class="flex items-center space-x-4 mt-4 md:mt-0"> <div class="flex items-center space-x-2"> <div class="p-2 bg-white/20 rounded-lg"> <ion-icon name="book-outline" class="text-2xl"></ion-icon> </div> <div> <div class="text-xl font-bold">85 WPM</div> <div class="text-xs text-sky-100">Reading Speed</div> </div> </div> <div class="flex items-center space-x-2"> <div class="p-2 bg-white/20 rounded-lg"> <ion-icon name="checkmark-done-outline" class="text-2xl"></ion-icon> </div> <div> <div class="text-xl font-bold">95%</div> <div class="text-xs text-sky-100">Accuracy</div> </div> </div> <div class="flex items-center space-x-2"> <div class="p-2 bg-white/20 rounded-lg"> <ion-icon name="chatbox-ellipses-outline" class="text-2xl"></ion-icon> </div> <div> <div class="text-xl font-bold">80%</div> <div class="text-xs text-sky-100">Comprehension</div> </div> </div> </div> </div> </div>
        </header>
        
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- Main content grid -->
            <div class="px-4 py-6 sm:px-0"> 
                <!-- Changed to a 2-column layout (lg:grid-cols-2) -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"> 
                    
                    <!-- TOP ROW -->
                    <!-- TOP LEFT: Skill Progress -->
                    <div id="skill-progress-container" class="bg-white p-6 rounded-xl shadow-md"> 
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">Skill Progress</h3> 
                        <div id="skill-progress-bars" class="space-y-5">
                            <!-- Content injected by renderSkillProgress() -->
                        </div> 
                    </div>

                    <!-- TOP RIGHT: Daily Practice Minutes (Chart) -->
                    <div class="bg-white p-6 rounded-xl shadow-md"> 
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">Daily Practice Minutes (Past Week)</h3> 
                        <div class="chart-container relative w-full h-56"> 
                            <canvas id="subjectChart"></canvas> 
                        </div> 
                        <p class="text-sm text-gray-500 mt-4">Total time this week: ~4h 30m</p>
                    </div> 

                </div>
                
                <!-- MIDDLE ROW (Activities & Time Spent) -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6"> 
                    <!-- BOTTOM LEFT: Recent Activities -->
                    <div class="bg-white p-6 rounded-xl shadow-md"> 
                        <div class="flex justify-between items-center mb-4"> 
                            <h3 class="text-xl font-semibold text-gray-900">Recent Activities</h3> 
                            <a href="#" class="text-sm font-medium text-accent hover:underline">View All</a> 
                        </div> 
                        <ul class="space-y-4"> 
                            <li class="flex items-center justify-between p-4 bg-gray-50 rounded-lg"> 
                                <div class="flex items-center space-x-3"> 
                                    <div class="p-2 rounded-full bg-green-100 text-green-600"><ion-icon name="book-outline" class="text-xl"></ion-icon></div> 
                                    <div> 
                                        <p class="font-medium text-gray-900">Completed Reading Fluency Test</p> 
                                        <p class="text-sm text-gray-500">Speed: 88 WPM, Accuracy: 95% • 1 hour ago</p> 
                                    </div> 
                                </div> 
                                <span class="text-sm font-semibold text-green-600">Excellent</span> 
                            </li> 
                            <li class="flex items-center justify-between p-4 bg-gray-50 rounded-lg"> 
                                <div class="flex items-center space-x-3"> 
                                    <div class="p-2 rounded-full bg-blue-100 text-blue-600"><ion-icon name="chatbox-ellipses-outline" class="text-xl"></ion-icon></div> 
                                    <div> 
                                        <p class="font-medium text-gray-900">Finished Comprehension Practice</p> 
                                        <p class="text-sm text-gray-500">Score: 8/10 • 2 hours ago</p> 
                                    </div> 
                                </div> 
                                <span class="text-sm font-semibold text-blue-600">Good</span> 
                            </li> 
                            <li class="flex items-center justify-between p-4 bg-gray-50 rounded-lg"> 
                                <div class="flex items-center space-x-3"> 
                                    <div class="p-2 rounded-full bg-violet-100 text-violet-600"><ion-icon name="library-outline" class="text-xl"></ion-icon></div> 
                                    <div> 
                                        <p class="font-medium text-gray-900">Vocabulary Quiz</p> 
                                        <p class="text-sm text-gray-500">Score: 9/10 • Yesterday</p> 
                                    </div> 
                                </div> 
                                <span class="text-sm font-semibold text-violet-600">Excellent</span> 
                            </li> 
                        </ul> 
                    </div> 

                    <!-- BOTTOM RIGHT: Time Spent This Week -->
                    <div class="bg-white p-6 rounded-xl shadow-md"> 
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">Time Spent This Week</h3> 
                        <div class="space-y-4"> 
                            <div> 
                                <div class="flex justify-between mb-1"> <span class="text-sm font-medium text-gray-700">Reading Practice</span> <span class="text-sm font-medium text-gray-500">2h 45m</span> </div> 
                                <div class="w-full bg-gray-200 rounded-full h-2"> <div class="bg-blue-500 h-2 rounded-full" style="width: 60%"></div> </div> 
                            </div> 
                            <div> 
                                <div class="flex justify-between mb-1"> <span class="text-sm font-medium text-gray-700">Vocabulary Games</span> <span class="text-sm font-medium text-gray-500">1h 15m</span> </div> 
                                <div class="w-full bg-gray-200 rounded-full h-2"> <div class="bg-violet-500 h-2 rounded-full" style="width: 25%"></div> </div> 
                            </div> 
                            <div> 
                                <div class="flex justify-between mb-1"> <span class="text-sm font-medium text-gray-700">Comprehension Tasks</span> <span class="text-sm font-medium text-gray-500">1h 00m</span> </div> 
                                <div class="w-full bg-gray-200 rounded-full h-2"> <div class="bg-amber-500 h-2 rounded-full" style="width: 15%"></div> </div> 
                            </div> 
                        </div> 
                    </div> 
                </div>

                <!-- BOTTOM SECTION: Recommended Actions (Full Width) -->
                <div class="mt-6">
                    <div class="bg-white p-6 rounded-xl shadow-md"> 
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">Recommended Actions</h3> 
                        <ul class="space-y-3"> 
                            <li class="flex items-center justify-between p-4 bg-gray-50 rounded-lg"> 
                                <div class="flex items-center"> 
                                    <span class="text-xs font-bold text-orange-600 bg-orange-100 px-2 py-1 rounded-full mr-3">MEDIUM</span> 
                                    <div> <p class="font-medium text-gray-900">Practice Complex Sentences</p> <p class="text-sm text-gray-600">Assign reading passages with longer sentences to improve fluency.</p> </div> 
                                </div> 
                                <button onclick="handleFindPassages()" class="bg-accent text-white font-medium px-4 py-2 rounded-lg text-sm hover:bg-accent-dark">Find Passages</button> 
                            </li> 
                            <li class="flex items-center justify-between p-4 bg-gray-50 rounded-lg"> 
                                <div class="flex items-center"> 
                                    <span class="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded-full mr-3">LOW</span> 
                                    <div> <p class="font-medium text-gray-900">Review Comprehension Strategy</p> <p class="text-sm text-gray-600">Go over strategies for identifying the main idea in texts.</p> </div> 
                                </div> 
                                <button onclick="handleViewTips()" class="bg-accent text-white font-medium px-4 py-2 rounded-lg text-sm hover:bg-accent-dark">View Tips</button> 
                            </li> 
                        </ul> 
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- PAGE 3: INSIGHTS -->
    <div id="page-insights" class="page">
        <!-- Header updated -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <div class="logo-container">
                             <!-- Logo for SoundSlate: Sleek 'S' in a rounded box -->
                            <div class="w-6 h-6 rounded-md flex items-center justify-center font-black text-white" style="background-color: var(--accent); font-size: 1.25rem; line-height: 1;">S</div>
                            <div class="soundslate-logo-text">SOUNDSLATE</div>
                        </div>
                        <nav class="hidden md:flex space-x-2">
                            <a href="#" onclick="navigateTo('page-home')" data-page="page-home" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="home-outline" class="text-xl"></ion-icon> Home </a>
                            <a href="#" onclick="navigateTo('page-progress')" data-page="page-progress" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="stats-chart-outline" class="text-xl"></ion-icon> Progress </a>
                            <a href="#" onclick="navigateTo('page-insights')" data-page="page-insights" class="nav-link active flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="bulb-outline" class="text-xl"></ion-icon> Insights </a>
                            <a href="#" onclick="navigateTo('page-generator')" data-page="page-generator" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="sparkles-outline" class="text-xl"></ion-icon> AI Content </a>
                            <a href="#" onclick="navigateTo('page-reports')" data-page="page-reports" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="document-text-outline" class="text-xl"></ion-icon> Reports </a>
                            <a href="#" onclick="navigateTo('page-assessment')" data-page="page-assessment" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="play-outline" class="text-xl"></ion-icon> Assessment </a>
                        </nav>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="user-avatar-insights" class="w-8 h-8 rounded-full bg-starry-night text-white flex items-center justify-center font-semibold bg-cover bg-center">A</div>
                        <span id="user-name-insights" class="hidden md:block text-sm font-medium text-gray-700">Hi, Abhishek!</span>
                        <div class="flex items-center space-x-1 relative">
                            <!-- Notification Button - opens modal via JS -->
                            <button onclick="toggleNotificationDropdown(event)" class="notification-badge-container text-gray-500 hover:text-white hover:bg-accent p-2 rounded-full transition-all duration-200" title="Notifications"> <ion-icon name="notifications-outline" class="text-2xl"></ion-icon> <span class="notification-badge"></span> </button>
                            <!-- NOTE: Notification Dropdown HTML is removed from here -->
                            <button onclick="navigateTo('page-settings')" class="text-gray-500 hover:text-white hover:bg-accent p-2 rounded-full transition-all duration-200" title="Settings"> <ion-icon name="settings-outline" class="text-2xl"></ion-icon> </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Page Content -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- Content with added chart placeholder and recommendations (unchanged from previous) -->
            <div class="px-4 py-6 sm:px-0"> <h1 class="text-3xl font-bold text-gray-900 mb-2">AI-Powered Insights</h1> <p class="text-lg text-gray-600 mb-8">Discover patterns and recommendations based on Akash's learning habits.</p> <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"> <div class="lg:col-span-2 space-y-6"> <div class="bg-white p-6 rounded-xl shadow-md"> <h3 class="text-xl font-semibold text-gray-900 mb-4">Key Insights</h3> <ul class="space-y-4"> <li class="flex items-start space-x-3"> <div class="p-2 rounded-full bg-sky-100 text-sky-600 mt-1"><ion-icon name="trending-up-outline" class="text-xl"></ion-icon></div> <div> <p class="font-medium text-gray-900">Progress Trend: Reading</p> <p class="text-sm text-gray-600">Reading comprehension has improved by 15% this week. He is consistently performing well in this area. Great progress!</p> <button class="text-sm font-semibold text-accent hover:underline mt-1">View Reading Details</button> </div> </li> <li class="flex items-start space-x-3"> <div class="p-2 rounded-full bg-sky-100 text-sky-600 mt-1"><ion-icon name="alarm-outline" class="text-xl"></ion-icon></div> <div> <p class="font-medium text-gray-900">Optimal Study Time</p> <p class="text-sm text-gray-600">Best performance and focus observed between 4-6 PM. Schedule reading practice during this time for better results.</p> <button class="text-sm font-semibold text-accent hover:underline mt-1">Set Study Reminder</button> </div> </li> <li class="flex items-start space-x-3"> <div class="p-2 rounded-full bg-sky-100 text-sky-600 mt-1"><ion-icon name="speedometer-outline" class="text-xl"></ion-icon></div> <div> <p class="font-medium text-gray-900">Pacing Suggestion</p> <p class="text-sm text-gray-600">Akash shows good speed in reading fluency tests. Ensure he also takes time to fully comprehend the text afterwards.</p> <button class="text-sm font-semibold text-accent hover:underline mt-1">Discuss with Teacher</button> </div> </li> <li class="flex items-start space-x-3"> <div class="p-2 rounded-full bg-yellow-100 text-yellow-600 mt-1"><ion-icon name="alert-circle-outline" class="text-xl"></ion-icon></div> <div> <p class="font-medium text-gray-900">Vocabulary Focus</p> <p class="text-sm text-gray-600">While vocabulary is strong overall, introducing more complex synonyms could further enhance writing and comprehension skills.</p> <button class="text-sm font-semibold text-accent hover:underline mt-1">Find Vocabulary Games</button> </div> </li> </ul> </div> <div class="bg-white p-6 rounded-xl shadow-md"> <h3 class="text-xl font-semibold text-gray-900 mb-4">Focus Trend Over Time</h3> <div class="h-64 bg-gray-100 rounded-lg flex items-center justify-center"> <p class="text-gray-500 italic">Line chart showing focus levels over the past month will appear here.</p> </div> </div> </div> <div class="lg:col-span-1 space-y-6"> <div class="bg-white p-6 rounded-xl shadow-md"> <h3 class="text-xl font-semibold text-gray-900 mb-4">Learning Habits</h3> <ul class="space-y-3"> <li class="flex items-center space-x-3"> <div class="p-2 rounded-full bg-green-100 text-green-600"><ion-icon name="checkmark-circle-outline" class="text-xl"></ion-icon></div> <p class="text-sm text-gray-600">Consistent study times</p> </li> <li class="flex items-center space-x-3"> <div class="p-2 rounded-full bg-green-100 text-green-600"><ion-icon name="book-outline" class="text-xl"></ion-icon></div> <p class="text-sm text-gray-600">High engagement in Reading</p> </li> <li class="flex items-center space-x-3"> <div class="p-2 rounded-full bg-green-100 text-green-600"><ion-icon name="timer-outline" class="text-xl"></ion-icon></div> <p class="text-sm text-gray-600">Good focus during 4-6 PM</p> </li> <li class="flex items-center space-x-3"> <div class="p-2 rounded-full bg-yellow-100 text-yellow-600"><ion-icon name="alert-circle-outline" class="text-xl"></ion-icon></div> <p class="text-sm text-gray-600">Slight hesitation on complex words</p> </li> </ul> </div> <div class="bg-white p-6 rounded-xl shadow-md"> <h3 class="text-xl font-semibold text-gray-900 mb-4">AI Recommendations</h3> <ul class="space-y-4"> <li class="flex items-start space-x-3"> <div class="p-2 rounded-full bg-sky-100 text-sky-600 mt-1 flex-shrink-0"><ion-icon name="reader-outline" class="text-xl"></ion-icon></div> <div> <p class="font-medium text-gray-900">Challenging Texts</p> <p class="text-sm text-gray-600">Introduce short stories or articles slightly above Akash's current reading level to encourage vocabulary growth and comprehension practice.</p> </div> </li> <li class="flex items-start space-x-3"> <div class="p-2 rounded-full bg-sky-100 text-sky-600 mt-1 flex-shrink-0"><ion-icon name="timer-outline" class="text-xl"></ion-icon></div> <div> <p class="font-medium text-gray-900">Timed Reading</p> <p class="text-sm text-gray-600">Incorporate short, timed reading exercises (1-2 minutes) followed by quick comprehension checks to improve both speed and focus.</p> </div> </li> </ul> </div> </div> </div> </div>
        </main>
    </div>

    <!-- PAGE 9: AI CONTENT GENERATOR (NEW) -->
    <div id="page-generator" class="page">
        <!-- Header updated -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <div class="logo-container">
                            <!-- Logo for SoundSlate: Sleek 'S' in a rounded box -->
                            <div class="w-6 h-6 rounded-md flex items-center justify-center font-black text-white" style="background-color: var(--accent); font-size: 1.25rem; line-height: 1;">S</div>
                            <div class="soundslate-logo-text">SOUNDSLATE</div>
                        </div>
                        <nav class="hidden md:flex space-x-2">
                            <a href="#" onclick="navigateTo('page-home')" data-page="page-home" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="home-outline" class="text-xl"></ion-icon> Home </a>
                            <a href="#" onclick="navigateTo('page-progress')" data-page="page-progress" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="stats-chart-outline" class="text-xl"></ion-icon> Progress </a>
                            <a href="#" onclick="navigateTo('page-insights')" data-page="page-insights" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="bulb-outline" class="text-xl"></ion-icon> Insights </a>
                            <a href="#" onclick="navigateTo('page-generator')" data-page="page-generator" class="nav-link active flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="sparkles-outline" class="text-xl"></ion-icon> AI Content </a>
                            <a href="#" onclick="navigateTo('page-reports')" data-page="page-reports" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="document-text-outline" class="text-xl"></ion-icon> Reports </a>
                            <a href="#" onclick="navigateTo('page-assessment')" data-page="page-assessment" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="play-outline" class="text-xl"></ion-icon> Assessment </a>
                        </nav>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="user-avatar-generator" class="w-8 h-8 rounded-full bg-starry-night text-white flex items-center justify-center font-semibold bg-cover bg-center">A</div>
                        <span id="user-name-generator" class="hidden md:block text-sm font-medium text-gray-700">Hi, Abhishek!</span>
                        <div class="flex items-center space-x-1 relative">
                            <!-- Notification Button - opens modal via JS -->
                            <button onclick="toggleNotificationDropdown(event)" class="notification-badge-container text-gray-500 hover:text-white hover:bg-accent p-2 rounded-full transition-all duration-200" title="Notifications"> <ion-icon name="notifications-outline" class="text-2xl"></ion-icon> <span class="notification-badge"></span> </button>
                            <button onclick="navigateTo('page-settings')" class="text-gray-500 hover:text-white hover:bg-accent p-2 rounded-full transition-all duration-200" title="Settings"> <ion-icon name="settings-outline" class="text-2xl"></ion-icon> </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Page Content -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">AI Content Generator</h1>
                <p class="text-lg text-gray-600 mb-8">Generate custom learning materials based on a topic for Akash.</p>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Generator Controls -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md h-min space-y-6">
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">Customize Content</h3>
                        
                        <!-- Content Type Selector -->
                        <div>
                            <label for="content-type-selector" class="block text-sm font-medium text-gray-900 mb-1">Content Type</label>
                            <select id="content-type-selector" name="content-type" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-accent focus:border-accent sm:text-sm">
                                <option>Study Guide</option>
                                <option>Creative Story Prompt</option>
                                <option>Vocabulary Challenge</option>
                            </select>
                        </div>
                        
                        <!-- Topic Prompt Area -->
                        <div>
                            <label for="generator-prompt" class="block text-sm font-medium text-gray-900 mb-1">Topic/Prompt (e.g., "The lifecycle of a butterfly")</label>
                            <textarea id="generator-prompt" rows="4" placeholder="Enter the topic or a detailed request here..." class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-accent focus:border-accent resize-none"></textarea>
                            <p class="text-xs text-gray-500 mt-1">Provide at least 10 characters.</p>
                        </div>

                        <!-- Generate Button -->
                        <button id="generate-content-btn" onclick="handleGenerateContent()" class="w-full bg-accent text-white font-semibold px-5 py-3 rounded-lg shadow-md hover:bg-accent-dark transition duration-200 flex items-center justify-center gap-2">
                            <ion-icon name="sparkles-outline" class="text-xl"></ion-icon> Generate Content
                        </button>
                    </div>

                    <!-- Generated Output -->
                    <div class="lg:col-span-2 space-y-6">
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">Generated Output</h3>
                        <div id="generated-content-results" class="bg-gray-50 text-gray-700 hidden">
                            <!-- Content or Loading state injected here -->
                        </div>
                        <div id="initial-message" class="bg-white p-6 rounded-xl shadow-md text-center text-gray-500">
                             <ion-icon name="chatbubble-ellipses-outline" class="text-4xl mb-2 text-accent"></ion-icon>
                             <p class="text-md font-medium">Enter a topic and hit 'Generate' to create custom learning materials for Akash.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- PAGE 4: REPORTS -->
    <div id="page-reports" class="page">
        <!-- Header updated -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <div class="logo-container">
                            <!-- Logo for SoundSlate: Sleek 'S' in a rounded box -->
                            <div class="w-6 h-6 rounded-md flex items-center justify-center font-black text-white" style="background-color: var(--accent); font-size: 1.25rem; line-height: 1;">S</div>
                            <div class="soundslate-logo-text">SOUNDSLATE</div>
                        </div>
                        <nav class="hidden md:flex space-x-2">
                            <a href="#" onclick="navigateTo('page-home')" data-page="page-home" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="home-outline" class="text-xl"></ion-icon> Home </a>
                            <a href="#" onclick="navigateTo('page-progress')" data-page="page-progress" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="stats-chart-outline" class="text-xl"></ion-icon> Progress </a>
                            <a href="#" onclick="navigateTo('page-insights')" data-page="page-insights" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="bulb-outline" class="text-xl"></ion-icon> Insights </a>
                            <a href="#" onclick="navigateTo('page-generator')" data-page="page-generator" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="sparkles-outline" class="text-xl"></ion-icon> AI Content </a>
                            <a href="#" onclick="navigateTo('page-reports')" data-page="page-reports" class="nav-link active flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="document-text-outline" class="text-xl"></ion-icon> Reports </a>
                            <a href="#" onclick="navigateTo('page-assessment')" data-page="page-assessment" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="play-outline" class="text-xl"></ion-icon> Assessment </a>
                        </nav>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="user-avatar-reports" class="w-8 h-8 rounded-full bg-starry-night text-white flex items-center justify-center font-semibold bg-cover bg-center">A</div>
                        <span id="user-name-reports" class="hidden md:block text-sm font-medium text-gray-700">Hi, Abhishek!</span>
                        <div class="flex items-center space-x-1 relative">
                            <!-- Notification Button - opens modal via JS -->
                            <button onclick="toggleNotificationDropdown(event)" class="notification-badge-container text-gray-500 hover:text-white hover:bg-accent p-2 rounded-full transition-all duration-200" title="Notifications"> <ion-icon name="notifications-outline" class="text-2xl"></ion-icon> <span class="notification-badge"></span> </button>
                            <!-- NOTE: Notification Dropdown HTML is removed from here -->
                            <button onclick="navigateTo('page-settings')" class="text-gray-500 hover:text-white hover:bg-accent p-2 rounded-full transition-all duration-200" title="Settings"> <ion-icon name="settings-outline" class="text-2xl"></ion-icon> </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Page Content -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- Content with enhanced recent reports list -->
            <div class="px-4 py-6 sm:px-0"> 
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Download Reports</h1> 
                <p class="text-lg text-gray-600 mb-8">Generate new reports or download past reports for Akash.</p> 
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6"> 
                    <div class="bg-white p-6 rounded-xl shadow-md"> 
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">Generate New Report</h3> 
                        <div class="space-y-4"> 
                            <div> 
                                <label for="report-type" class="block text-sm font-medium text-gray-900">Report Type</label> 
                                <select id="report-type" name="report-type" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-accent focus:border-accent sm:text-sm"> 
                                    <option>Weekly Progress Summary</option> 
                                    <option>Monthly Deep Dive</option> 
                                    <option>Reading & Comprehension Report</option> 
                                </select> 
                            </div> 
                            <div> 
                                <label for="report-range" class="block text-sm font-medium text-gray-900">Date Range</label> 
                                <select id="report-range" name="report-range" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-accent focus:border-accent sm:text-sm"> 
                                    <option>Last 7 Days</option> 
                                    <option>Last 30 Days</option> 
                                    <option>This Quarter</option> 
                                </select> 
                            </div> 
                            <button onclick="handleGenerateReport()" class="w-full bg-accent text-white font-semibold px-5 py-3 rounded-lg shadow-md hover:bg-accent-dark transition duration-200 flex items-center justify-center gap-2"> 
                                <ion-icon name="document-text-outline" class="text-xl"></ion-icon> Generate & View Report 
                            </button> 
                        </div> 
                    </div> 
                    <div class="bg-white p-6 rounded-xl shadow-md"> 
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">Recent Reports (Simulated)</h3> 
                        <ul class="space-y-3"> 
                            <li class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition duration-150"> 
                                <div class="flex items-center space-x-3"> 
                                    <ion-icon name="document-outline" class="text-xl text-gray-500"></ion-icon> 
                                    <div> 
                                        <p class="font-medium text-gray-900">Weekly Summary</p> 
                                        <p class="text-sm text-gray-600">Oct 19, 2025 - Oct 25, 2025</p> 
                                    </div> 
                                </div> 
                                <button onclick="handleReportDownload('Weekly Summary', 'Oct 19-25')" class="text-accent hover:text-accent-dark" title="Download"> 
                                    <ion-icon name="download-outline" class="text-2xl"></ion-icon> 
                                </button> 
                            </li> 
                            <li class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition duration-150"> 
                                <div class="flex items-center space-x-3"> 
                                    <ion-icon name="reader-outline" class="text-xl text-gray-500"></ion-icon> 
                                    <div> 
                                        <p class="font-medium text-gray-900">Reading & Comprehension Report</p> 
                                        <p class="text-sm text-gray-600">Sep 1, 2025 - Sep 30, 2025</p> 
                                    </div> 
                                </div> 
                                <button onclick="handleReportDownload('Reading & Comprehension Report', 'Sep 1-30')" class="text-accent hover:text-accent-dark" title="Download"> 
                                    <ion-icon name="download-outline" class="text-2xl"></ion-icon> 
                                </button> 
                            </li> 
                            <li class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition duration-150"> 
                                <div class="flex items-center space-x-3"> 
                                    <ion-icon name="calendar-outline" class="text-xl text-gray-500"></ion-icon> 
                                    <div> 
                                        <p class="font-medium text-gray-900">Monthly Deep Dive</p> 
                                        <p class="text-sm text-gray-600">September 2025</p> 
                                    </div> 
                                </div> 
                                <button onclick="handleReportDownload('Monthly Deep Dive', 'September')" class="text-accent hover:text-accent-dark" title="Download"> 
                                    <ion-icon name="download-outline" class="text-2xl"></ion-icon> 
                                </button> 
                            </li> 
                        </ul> 
                        <p class="text-xs text-red-500 mt-4">Note: Only "Weekly Summary" download is authorized in this demo.</p>
                    </div> 
                </div> 
            </div>
        </main>
    </div>

    <!-- PAGE 5: SETTINGS -->
    <div id="page-settings" class="page">
        <!-- Header updated -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <div class="logo-container">
                            <!-- Logo for SoundSlate: Sleek 'S' in a rounded box -->
                            <div class="w-6 h-6 rounded-md flex items-center justify-center font-black text-white" style="background-color: var(--accent); font-size: 1.25rem; line-height: 1;">S</div>
                            <div class="soundslate-logo-text">SOUNDSLATE</div>
                        </div>
                        <nav class="hidden md:flex space-x-2">
                            <a href="#" onclick="navigateTo('page-home')" data-page="page-home" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="home-outline" class="text-xl"></ion-icon> Home </a>
                            <a href="#" onclick="navigateTo('page-progress')" data-page="page-progress" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="stats-chart-outline" class="text-xl"></ion-icon> Progress </a>
                            <a href="#" onclick="navigateTo('page-insights')" data-page="page-insights" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="bulb-outline" class="text-xl"></ion-icon> Insights </a>
                            <a href="#" onclick="navigateTo('page-generator')" data-page="page-generator" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="sparkles-outline" class="text-xl"></ion-icon> AI Content </a>
                            <a href="#" onclick="navigateTo('page-reports')" data-page="page-reports" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="document-text-outline" class="text-xl"></ion-icon> Reports </a>
                            <a href="#" onclick="navigateTo('page-assessment')" data-page="page-assessment" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="play-outline" class="text-xl"></ion-icon> Assessment </a>
                        </nav>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="user-avatar-settings" class="w-8 h-8 rounded-full bg-starry-night text-white flex items-center justify-center font-semibold bg-cover bg-center">A</div>
                        <span id="user-name-settings" class="hidden md:block text-sm font-medium text-gray-700">Hi, Abhishek!</span>
                        <div class="flex items-center space-x-1 relative">
                            <!-- Notification Button - opens modal via JS -->
                            <button onclick="toggleNotificationDropdown(event)" class="notification-badge-container text-gray-500 hover:text-white hover:bg-accent p-2 rounded-full transition-all duration-200" title="Notifications"> <ion-icon name="notifications-outline" class="text-2xl"></ion-icon> <span class="notification-badge"></span> </button>
                            <!-- NOTE: Notification Dropdown HTML is removed from here -->
                            <button onclick="navigateTo('page-settings')" class="text-gray-500 hover:text-white hover:bg-accent p-2 rounded-full transition-all duration-200" title="Settings"> <ion-icon name="settings-outline" class="text-2xl"></ion-icon> </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Page Content: Added Theme Toggle -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Settings</h1>
                <div class="bg-white p-6 rounded-xl shadow-md max-w-lg space-y-6"> <!-- Added space-y-6 -->
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900 mb-2">Appearance</h2>
                        <div class="flex justify-between items-center">
                            <label for="theme-toggle" class="text-sm font-medium text-gray-700">Dark Mode</label>
                            <div class="theme-switch-wrapper">
                                <label class="theme-switch">
                                    <input type="checkbox" id="theme-toggle">
                                    <span class="slider">
                                        <!-- Sun icon for light mode -->
                                        <ion-icon name="sunny-outline" class="sun"></ion-icon> 
                                        <!-- Moon icon for dark mode -->
                                        <ion-icon name="moon-outline" class="moon"></ion-icon> 
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="border-t pt-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">Account</h2>
                        <p class="text-gray-600 mb-6">Manage your account settings and preferences.</p>
                        <button onclick="document.getElementById('logout-modal').classList.remove('hidden')" class="bg-red-600 hover:bg-red-700 text-white font-semibold px-5 py-3 rounded-lg shadow-md transition duration-200 flex items-center gap-2"> <ion-icon name="log-out" class="text-xl"></ion-icon> Logout </button>
                        <p class="mt-8 text-gray-500 text-sm"> Other settings like notification preferences and child management will appear here. </p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- PAGE 6: ASSESSMENT HUB -->
    <div id="page-assessment" class="page">
        <!-- Header updated -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <div class="logo-container">
                            <!-- Logo for SoundSlate: Sleek 'S' in a rounded box -->
                            <div class="w-6 h-6 rounded-md flex items-center justify-center font-black text-white" style="background-color: var(--accent); font-size: 1.25rem; line-height: 1;">S</div>
                            <div class="soundslate-logo-text">SOUNDSLATE</div>
                        </div>
                        <nav class="hidden md:flex space-x-2">
                            <a href="#" onclick="navigateTo('page-home')" data-page="page-home" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="home-outline" class="text-xl"></ion-icon> Home </a>
                            <a href="#" onclick="navigateTo('page-progress')" data-page="page-progress" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="stats-chart-outline" class="text-xl"></ion-icon> Progress </a>
                            <a href="#" onclick="navigateTo('page-insights')" data-page="page-insights" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="bulb-outline" class="text-xl"></ion-icon> Insights </a>
                            <a href="#" onclick="navigateTo('page-generator')" data-page="page-generator" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="sparkles-outline" class="text-xl"></ion-icon> AI Content </a>
                            <a href="#" onclick="navigateTo('page-reports')" data-page="page-reports" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="document-text-outline" class="text-xl"></ion-icon> Reports </a>
                            <a href="#" onclick="navigateTo('page-assessment')" data-page="page-assessment" class="nav-link active flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="play-outline" class="text-xl"></ion-icon> Assessment </a>
                        </nav>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="user-avatar-assessment" class="w-8 h-8 rounded-full bg-starry-night text-white flex items-center justify-center font-semibold bg-cover bg-center">A</div>
                        <span id="user-name-assessment" class="hidden md:block text-sm font-medium text-gray-700">Hi, Abhishek!</span>
                        <div class="flex items-center space-x-1 relative">
                            <!-- Notification Button - opens modal via JS -->
                            <button onclick="toggleNotificationDropdown(event)" class="notification-badge-container text-gray-500 hover:text-white hover:bg-accent p-2 rounded-full transition-all duration-200" title="Notifications"> <ion-icon name="notifications-outline" class="text-2xl"></ion-icon> <span class="notification-badge"></span> </button>
                            <!-- NOTE: Notification Dropdown HTML is removed from here -->
                            <button onclick="navigateTo('page-settings')" class="text-gray-500 hover:text-white hover:bg-accent p-2 rounded-full transition-all duration-200" title="Settings"> <ion-icon name="settings-outline" class="text-2xl"></ion-icon> </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Page Content (unchanged) -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8"> <div class="px-4 py-6 sm:px-0"> <h1 class="text-3xl font-bold text-gray-900 mb-2">Start a New Assessment</h1> <p class="text-lg text-gray-600 mb-8">Select a skill area to begin a short assessment for Akash.</p> <div class="grid grid-cols-1 md:grid-cols-2 gap-6"> <div class="bg-white p-6 rounded-xl shadow-md flex flex-col justify-between"> <div> <div class="p-3 rounded-full bg-blue-100 text-blue-600 w-12 h-12 flex items-center justify-center mb-3"><ion-icon name="mic-outline" class="text-3xl"></ion-icon></div> <h3 class="text-lg font-semibold text-gray-900 mb-1">Reading Fluency</h3> <p class="text-gray-600 text-sm mb-4">Assesses reading speed and accuracy by recording Akash reading aloud. (Approx. 5 mins)</p> </div> <button onclick="navigateTo('page-assessment-reading')" class="w-full bg-accent text-white font-semibold px-5 py-3 rounded-lg shadow-md hover:bg-accent-dark transition duration-200 flex items-center justify-center gap-2"> Start Assessment </button> </div> 
            
            <div class="bg-white p-6 rounded-xl shadow-md flex flex-col justify-between"> <div> <div class="p-3 rounded-full bg-violet-100 text-violet-600 w-12 h-12 flex items-center justify-center mb-3"><ion-icon name="image-outline" class="text-3xl"></ion-icon></div> <h3 class="text-lg font-semibold text-gray-900 mb-1">Comprehension & Handwriting</h3> <p class="text-gray-600 text-sm mb-4">Analyze a written response (typed or image) for comprehension. Optionally, analyze handwriting for dyslexic traits.</p> </div> <button onclick="navigateTo('page-assessment-comprehension')" class="w-full bg-accent text-white font-semibold px-5 py-3 rounded-lg shadow-md hover:bg-accent-dark transition duration-200 flex items-center justify-center gap-2"> Start Assessment </button> </div> 

            <div class="bg-gray-100 p-6 rounded-xl border border-dashed border-gray-300 flex flex-col justify-center items-center text-center md:col-span-2"> <div class="p-3 rounded-full bg-gray-200 text-gray-500 w-12 h-12 flex items-center justify-center mb-3"><ion-icon name="add-outline" class="text-3xl"></ion-icon></div> <h3 class="text-lg font-semibold text-gray-600 mb-1">More Soon</h3> <p class="text-gray-500 text-sm">Additional assessment types will be available here.</p> </div> 
        </div> </div> </main>
    </div>

    <!-- PAGE 7: READING ASSESSMENT PAGE -->
    <div id="page-assessment-reading" class="page">
        <!-- Header updated -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <div class="logo-container">
                            <!-- Logo for SoundSlate: Sleek 'S' in a rounded box -->
                            <div class="w-6 h-6 rounded-md flex items-center justify-center font-black text-white" style="background-color: var(--accent); font-size: 1.25rem; line-height: 1;">S</div>
                            <div class="soundslate-logo-text">SOUNDSLATE</div>
                        </div>
                        <nav class="hidden md:flex space-x-2">
                            <a href="#" onclick="navigateTo('page-home')" data-page="page-home" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="home-outline" class="text-xl"></ion-icon> Home </a>
                            <a href="#" onclick="navigateTo('page-progress')" data-page="page-progress" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="stats-chart-outline" class="text-xl"></ion-icon> Progress </a>
                            <a href="#" onclick="navigateTo('page-insights')" data-page="page-insights" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="bulb-outline" class="text-xl"></ion-icon> Insights </a>
                            <a href="#" onclick="navigateTo('page-generator')" data-page="page-generator" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="sparkles-outline" class="text-xl"></ion-icon> AI Content </a>
                            <a href="#" onclick="navigateTo('page-reports')" data-page="page-reports" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="document-text-outline" class="text-xl"></ion-icon> Reports </a>
                            <a href="#" onclick="navigateTo('page-assessment')" data-page="page-assessment" class="nav-link active flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="play-outline" class="text-xl"></ion-icon> Assessment </a>
                        </nav>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="user-avatar-assessment-reading" class="w-8 h-8 rounded-full bg-starry-night text-white flex items-center justify-center font-semibold bg-cover bg-center">A</div>
                        <span id="user-name-assessment-reading" class="hidden md:block text-sm font-medium text-gray-700">Hi, Abhishek!</span>
                        <div class="flex items-center space-x-1 relative">
                            <!-- Notification Button - opens modal via JS -->
                            <button onclick="toggleNotificationDropdown(event)" class="notification-badge-container text-gray-500 hover:text-white hover:bg-accent p-2 rounded-full transition-all duration-200" title="Notifications"> <ion-icon name="notifications-outline" class="text-2xl"></ion-icon> <span class="notification-badge"></span> </button>
                            <!-- NOTE: Notification Dropdown HTML is removed from here -->
                            <button onclick="navigateTo('page-settings')" class="text-gray-500 hover:text-white hover:bg-accent p-2 rounded-full transition-all duration-200" title="Settings"> <ion-icon name="settings-outline" class="text-2xl"></ion-icon> </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Page Content with Previous Results section -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">
                <button onclick="navigateTo('page-assessment')" class="text-sm text-gray-600 hover:text-accent mb-4 inline-flex items-center gap-1"> <ion-icon name="arrow-back-outline"></ion-icon> Back to Assessments </button>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Reading Fluency Assessment</h1>
                <p class="text-lg text-gray-600 mb-8">Record Akash reading the passage below.</p>
                <div class="bg-white p-6 rounded-xl shadow-md max-w-2xl mx-auto space-y-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Passage to Read:</h3>
                        <div class="bg-gray-50 p-4 rounded-lg border mb-4"> <p id="reading-passage" class="text-gray-800 text-lg leading-relaxed"></p> </div>
                        <div class="flex items-center justify-center space-x-4 mb-4"> <span id="recording-status" class="text-sm font-medium text-gray-500 flex items-center gap-2"></span> </div>
                        <div class="flex justify-center space-x-3 mb-6"> <button id="start-record-btn" onclick="startRecording()" class="bg-green-500 hover:bg-green-600 text-white font-semibold px-5 py-3 rounded-lg shadow-md transition duration-200 flex items-center gap-2"> <ion-icon name="mic-circle-outline" class="text-xl"></ion-icon> Start </button> <button id="pause-record-btn" onclick="pauseRecording()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold px-5 py-3 rounded-lg shadow-md transition duration-200 flex items-center gap-2 hidden"> <ion-icon name="pause-outline" class="text-xl"></ion-icon> Pause </button> <button id="resume-record-btn" onclick="resumeRecording()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-5 py-3 rounded-lg shadow-md transition duration-200 flex items-center gap-2 hidden"> <ion-icon name="play-outline" class="text-xl"></ion-icon> Resume </button> <button id="stop-record-btn" onclick="stopRecording()" class="bg-red-500 hover:bg-red-600 text-white font-semibold px-5 py-3 rounded-lg shadow-md transition duration-200 flex items-center gap-2 hidden"> <ion-icon name="stop-circle-outline" class="text-xl"></ion-icon> Stop </button> </div>
                        <div id="reading-assessment-results" class="mt-4 p-4 bg-gray-100 rounded-lg text-sm text-gray-600 hidden"> <p class="font-medium text-gray-800 mb-1">Assessment Results:</p> <p>Placeholder...</p> </div>
                    </div>
                    <!-- Previous Results Section -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-3 border-t pt-6">Previous Results</h3>
                        <ul class="space-y-3">
                            <li class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"> <div> <p class="font-medium text-gray-800 text-sm">Oct 24, 2025</p> <p class="text-xs text-gray-600">Speed: 85 WPM, Accuracy: 94%</p> </div> <span class="text-sm font-semibold text-green-600">Good</span> </li>
                            <li class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"> <div> <p class="font-medium text-gray-800 text-sm">Oct 17, 2025</p> <p class="text-xs text-gray-600">Speed: 82 WPM, Accuracy: 92%</p> </div> <span class="text-sm font-semibold text-yellow-600">Fair</span> </li>
                        </ul>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- PAGE 8: COMPREHENSION ASSESSMENT PAGE -->
    <div id="page-assessment-comprehension" class="page">
        <!-- Header updated -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <div class="logo-container">
                            <!-- Logo for SoundSlate: Sleek 'S' in a rounded box -->
                            <div class="w-6 h-6 rounded-md flex items-center justify-center font-black text-white" style="background-color: var(--accent); font-size: 1.25rem; line-height: 1;">S</div>
                            <div class="soundslate-logo-text">SOUNDSLATE</div>
                        </div>
                        <nav class="hidden md:flex space-x-2">
                            <a href="#" onclick="navigateTo('page-home')" data-page="page-home" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="home-outline" class="text-xl"></ion-icon> Home </a>
                            <a href="#" onclick="navigateTo('page-progress')" data-page="page-progress" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="stats-chart-outline" class="text-xl"></ion-icon> Progress </a>
                            <a href="#" onclick="navigateTo('page-insights')" data-page="page-insights" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="bulb-outline" class="text-xl"></ion-icon> Insights </a>
                            <a href="#" onclick="navigateTo('page-generator')" data-page="page-generator" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="sparkles-outline" class="text-xl"></ion-icon> AI Content </a>
                            <a href="#" onclick="navigateTo('page-reports')" data-page="page-reports" class="nav-link inactive flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="document-text-outline" class="text-xl"></ion-icon> Reports </a>
                            <a href="#" onclick="navigateTo('page-assessment')" data-page="page-assessment" class="nav-link active flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium"> <ion-icon name="play-outline" class="text-xl"></ion-icon> Assessment </a>
                        </nav>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="user-avatar-assessment-comp" class="w-8 h-8 rounded-full bg-starry-night text-white flex items-center justify-center font-semibold bg-cover bg-center">A</div>
                        <span id="user-name-assessment-comp" class="hidden md:block text-sm font-medium text-gray-700">Hi, Abhishek!</span>
                        <div class="flex items-center space-x-1 relative">
                            <!-- Notification Button - opens modal via JS -->
                            <button onclick="toggleNotificationDropdown(event)" class="notification-badge-container text-gray-500 hover:text-white hover:bg-accent p-2 rounded-full transition-all duration-200" title="Notifications"> <ion-icon name="notifications-outline" class="text-2xl"></ion-icon> <span class="notification-badge"></span> </button>
                            <!-- NOTE: Notification Dropdown HTML is removed from here -->
                            <button onclick="navigateTo('page-settings')" class="text-gray-500 hover:text-white hover:bg-accent p-2 rounded-full transition-all duration-200" title="Settings"> <ion-icon name="settings-outline" class="text-2xl"></ion-icon> </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Page Content with Previous Results section -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">
                <button onclick="navigateTo('page-assessment')" class="text-sm text-gray-600 hover:text-accent mb-4 inline-flex items-center gap-1"> <ion-icon name="arrow-back-outline"></ion-icon> Back to Assessments </button>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Comprehension & Handwriting</h1>
                <p class="text-lg text-gray-600 mb-8">Submit a response to the passage by typing or uploading an image.</p>
                
                <div class="bg-white p-6 rounded-xl shadow-md max-w-2xl mx-auto space-y-6">
                    
                    <!-- 1. GIVEN PASSAGE (Read-only) -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Passage for Comprehension:</h3>
                        <div class="bg-gray-50 p-4 rounded-lg border border-indigo-300/50">
                            <p id="comprehension-given-passage" class="text-gray-800 text-base leading-relaxed italic">Loading passage...</p>
                            <p class="text-xs text-gray-600 mt-2 font-medium">Read this text and use the space below to provide your written response or upload a file.</p>
                        </div>
                    </div>

                    <!-- 2. STUDENT INPUT MODE TOGGLE -->
                    <div class="flex justify-center space-x-3 p-1 rounded-lg bg-gray-100">
                        <button id="mode-upload-btn" onclick="setComprehensionMode('upload')" class="toggle-button active flex-1 px-4 py-2 rounded-md text-sm font-medium transition duration-150 flex items-center justify-center gap-2">
                             <ion-icon name="cloud-upload-outline"></ion-icon> Upload Image (Response)
                        </button>
                        <button id="mode-write-btn" onclick="setComprehensionMode('write')" class="toggle-button inactive flex-1 px-4 py-2 rounded-md text-sm font-medium transition duration-150 flex items-center justify-center gap-2">
                            <ion-icon name="pencil-outline"></ion-icon> Write Response
                        </button>
                    </div>

                    <!-- 3. INPUT CONTAINER (Dynamically Populated) -->
                    <div id="comprehension-input-area">
                        <!-- Initial Content (Upload) is set here by setupComprehensionAssessmentPage() -->
                    </div>

                    <div id="dyslexia-check-container" class="hidden">
                        <label for="dyslexia-check" class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <input id="dyslexia-check" type="checkbox" class="h-5 w-5 rounded text-accent focus:ring-accent">
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">Analyze Handwriting</p>
                                <p class="text-xs text-gray-600">Also check the handwriting in the image for dyslexic traits. (Uses additional analysis)</p>
                            </div>
                        </label>
                    </div>

                    <button id="start-comprehension-btn" onclick="startComprehensionAssessment()" disabled class="w-full bg-gray-400 text-white font-semibold px-5 py-3 rounded-lg shadow-md cursor-not-allowed flex items-center justify-center gap-2 transition duration-200"> <ion-icon name="play-circle-outline" class="text-xl"></ion-icon> Submit Response for Assessment </button>
                    
                    <div id="comprehension-assessment-results" class="mt-4 p-4 bg-gray-100 rounded-lg text-sm text-gray-600 hidden"> 
                        <!-- Combined report will be injected here -->
                    </div>
                    
                    <!-- Previous Results Section -->
                    <div>
                        <h3 class="lg:text-lg font-semibold text-gray-900 mb-3 border-t pt-6">Previous Results</h3>
                        <ul class="space-y-3">
                            <li class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"> <div> <p class="font-medium text-gray-800 text-sm">Oct 23, 2025 (Story: The Fox)</p> <p class="text-xs text-gray-600">Score: 8/10, Vocabulary: 9/10</p> </div> <span class="text-sm font-semibold text-blue-600">Good</span> </li>
                            <li class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"> <div> <p class="font-medium text-gray-800 text-sm">Oct 15, 2025 (Article: Planets)</p> <p class="text-xs text-gray-600">Score: 7/10, Vocabulary: 8/10</p> </div> <span class="text-sm font-semibold text-yellow-600">Fair</span> </li>
                        </ul>
                    </div>
                </div>
            </div>
        </main>
    </div>


    <!-- Common Modals and FABs -->
    <div id="fab-container" class="fixed bottom-6 right-6 space-y-3 z-40 hidden"> <button onclick="showToast('Connecting to teacher... (Demo)', 'info')" class="bg-starry-night text-white w-14 h-14 rounded-full shadow-md flex items-center justify-center transition-all duration-200 hover:scale-110 opacity-90 hover:opacity-100 hover:shadow-xl bg-cover bg-center" title="Chat with Teacher"> <ion-icon name="people" class="text-3xl"></ion-icon> </button> <button onclick="handleGenerateReport()" class="bg-starry-night text-white w-14 h-14 rounded-full shadow-md flex items-center justify-center transition-all duration-200 hover:scale-110 opacity-90 hover:opacity-100 hover:shadow-xl bg-cover bg-center" title="Generate Report"> <ion-icon name="document-text" class="text-3xl"></ion-icon> </button> <button onclick="toggleChat()" class="bg-starry-night text-white w-14 h-14 rounded-full shadow-md flex items-center justify-center transition-all duration-200 hover:scale-110 opacity-90 hover:opacity-100 hover:shadow-xl bg-cover bg-center" title="AI Assistant"> <ion-icon name="chatbubbles" class="text-3xl"></ion-icon> </button> </div>
    <div id="chat-widget" class="fixed bottom-24 right-6 w-80 h-96 bg-white rounded-2xl shadow-xl z-40 hidden flex-col overflow-hidden border"> <div class="p-4 bg-starry-gradient text-white flex justify-between items-center"> <h3 class="font-semibold text-lg">Boo - AI Assistant</h3> <button onclick="toggleChat()" class="text-white/80 hover:text-white"> <ion-icon name="close-outline" class="text-2xl"></ion-icon> </button> </div> <div id="chat-messages" class="flex-1 p-4 space-y-4 overflow-y-auto"> <div class="flex"><div class="chat-bubble chat-bubble-ai"> Hi! I'm Boo. How can I help you understand Akash's reading and comprehension progress today? </div></div> </div> <div class="p-4 border-t bg-white"> <form id="chat-form" class="flex items-center gap-2"> <input id="chat-input" type="text" placeholder="Ask about progress..." class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-accent"> <button type="submit" class="bg-accent text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-accent-dark"> <ion-icon name="arrow-up-outline" class="text-xl"></ion-icon> </button> </form> </div> </div>
    
    <!-- All Notifications Modal -->
    <div id="notification-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-lg max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-semibold text-gray-900">All Notifications</h3>
                <button onclick="document.getElementById('notification-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-800">
                    <ion-icon name="close-outline" class="text-3xl"></ion-icon>
                </button>
            </div>
            <div class="overflow-y-auto space-y-3">
                <!-- Full Notification List Content -->
                <div class="p-3 bg-gray-50 rounded-lg flex items-start space-x-3 hover:bg-gray-100 cursor-pointer">
                    <ion-icon name="trending-up-outline" class="text-xl text-green-600 flex-shrink-0 mt-1"></ion-icon>
                    <div>
                        <p class="font-medium text-gray-900">Reading speed increased!</p>
                        <p class="text-xs text-gray-600">Akash is now reading at 88 WPM. 2h ago</p>
                    </div>
                </div>
                <div onclick="navigateTo('page-reports'); document.getElementById('notification-modal').classList.add('hidden');" class="p-3 bg-gray-50 rounded-lg flex items-start space-x-3 hover:bg-gray-100 cursor-pointer">
                    <ion-icon name="document-text-outline" class="text-xl text-blue-600 flex-shrink-0 mt-1"></ion-icon>
                    <div>
                        <p class="font-medium text-gray-900">New weekly report available.</p>
                        <p class="text-xs text-gray-600">Summary for Oct 19-25 is ready. Yesterday</p>
                    </div>
                </div>
                <div onclick="navigateTo('page-insights'); document.getElementById('notification-modal').classList.add('hidden');" class="p-3 bg-gray-50 rounded-lg flex items-start space-x-3 hover:bg-gray-100 cursor-pointer">
                    <ion-icon name="bulb-outline" class="text-xl text-yellow-600 flex-shrink-0 mt-1"></ion-icon>
                    <div>
                        <p class="font-medium text-gray-900">Focus Area: Complex Words</p>
                        <p class="text-xs text-gray-600">AI suggests practice. 3d ago</p>
                    </div>
                </div>
                <!-- Duplicated content for scrolling effect -->
                <div class="p-3 bg-gray-50 rounded-lg flex items-start space-x-3 text-gray-500">
                    <ion-icon name="alarm-outline" class="text-xl text-gray-400 flex-shrink-0 mt-1"></ion-icon>
                    <div><p class="font-medium text-gray-900">Missed Practice Alert</p><p class="text-xs text-gray-600">Akash missed his optimal reading slot today. 4d ago</p></div>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg flex items-start space-x-3 text-gray-500">
                    <ion-icon name="bookmark-outline" class="text-xl text-gray-400 flex-shrink-0 mt-1"></ion-icon>
                    <div><p class="font-medium text-gray-900">New Vocabulary Set</p><p class="text-xs text-gray-600">Set 'Ocean Life' is ready for review. 5d ago</p></div>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg flex items-start space-x-3 text-gray-500">
                    <ion-icon name="trending-down-outline" class="text-xl text-gray-400 flex-shrink-0 mt-1"></ion-icon>
                    <div><p class="font-medium text-gray-900">Fluency Dip</p><p class="text-xs text-gray-600">A slight dip in fluency observed on Tuesday. 6d ago</p></div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6"> 
                <button onclick="document.getElementById('notification-modal').classList.add('hidden')" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300"> Close </button>
            </div>
        </div>
    </div>

    <!-- Modals (Logout, Report) -->
    <div id="logout-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden"> <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm"> <h3 class="text-lg font-medium text-gray-900 mb-2">Are you sure?</h3> <p class="text-sm text-gray-600 mb-4">Are you sure you want to log out?</p> <div class="flex justify-end space-x-3"> <button onclick="document.getElementById('logout-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300"> Cancel </button> <button onclick="handleLogout()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"> OK </button> </div> </div> </div>
    
    <!-- Report Modal (Used for Report and AI Passages) -->
    <div id="report-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden"> 
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col"> 
            <div class="flex justify-between items-center mb-4"> 
                <h3 id="report-modal-title" class="text-xl font-semibold text-gray-900">AI-Generated Progress Report</h3> 
                <button onclick="document.getElementById('report-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-800"> <ion-icon name="close-outline" class="text-3xl"></ion-icon> </button> 
            </div> 
            <div class="overflow-y-auto"> 
                <div id="report-content" class="text-sm text-gray-700 bg-gray-50 p-4 rounded-lg border"></div> 
            </div> 
            <div class="flex justify-end space-x-3 mt-6"> 
                <button onclick="document.getElementById('report-modal').classList.add('hidden')" class="px-5 py-2 bg-accent text-white rounded-lg hover:bg-accent-dark"> Done </button> 
            </div> 
        </div> 
    </div>

    <!-- New Tips Modal -->
    <div id="recommended-tips-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-semibold text-gray-900">Comprehension Improvement Tips</h3>
                <button onclick="document.getElementById('recommended-tips-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-800">
                    <ion-icon name="close-outline" class="text-3xl"></ion-icon>
                </button>
            </div>
            <div class="overflow-y-auto">
                <div id="tips-modal-content" class="text-sm text-gray-700 space-y-4">
                    <!-- Content injected by JS -->
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6"> 
                <button onclick="document.getElementById('recommended-tips-modal').classList.add('hidden')" class="px-5 py-2 bg-accent text-white rounded-lg hover:bg-accent-dark"> Got it! </button>
            </div>
        </div>
    </div>


    <div id="toast-notification" class="toast-notification"> <p id="toast-message">Default Toast Message</p> </div>

    <script>
        let currentUserName = "Abhishek";
        let subjectChart = null;
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;
        let selectedComprehensionFile = null;
        let currentComprehensionMode = 'upload'; // 'upload' or 'write'

        const MIN_COMPREHENSION_WORDS = 50;

        const HUGGINGFACE_API_URL = "https://sawanade-dyslexia-api.hf.space/run/predict"; // NOTE: This URL appears to be inactive (404 Not Found). Please replace it with a valid endpoint.

        // Sentences for Reading Fluency Assessment (Page 7)
        const readingPassages = [ 
            "The sun dipped below the horizon, painting the sky in shades of orange and purple.", 
            "A gentle breeze rustled the leaves in the tall oak trees.", 
            "Butterflies with vibrant wings danced among the colorful wildflowers.", 
            "The old lighthouse stood watch over the rocky coastline.", 
            "Children laughed as they built sandcastles on the beach.", 
            "A curious squirrel scampered up a tree, chattering loudly.", 
            "Stars began to appear one by one in the darkening twilight sky.", 
            "The wise owl hooted softly from its perch high above.", 
            "Waves crashed against the shore, creating a soothing rhythm.", 
            "A small boat sailed peacefully across the calm blue water." 
        ];

        // Sample passages for Comprehension Assessment
        const comprehensionPassages = [
            "A small town called Oakhaven was famous for its ancient clock tower. Every noon, it chimed twelve times, a sound that echoed through the surrounding valley. Recently, the clock began skipping chimes, sometimes ringing eleven, sometimes thirteen. The town elder believed this was a sign of a coming change, while the young clockmaker insisted it was merely a faulty spring that needed careful replacement. This mysterious development sparked significant speculation among the townspeople.",
            "The planet Xylos orbits a twin-star system, meaning it never truly experiences night. The inhabitants, known as Sylvans, have developed incredible bioluminescent abilities to cope with the perpetual light. They use patterns of light emission as their primary form of communication, a silent, colorful language of flashes and fades. This unique form of existence has dictated their entire social structure and architectural development over millennia.",
            "Professor Anya Sharma was a botanist who discovered an entirely new species of mushroom in the Amazon rainforest. This mushroom had a peculiar characteristic: it glowed intensely when exposed to low-frequency sound waves. Anya realized the potential for this discovery, especially for deep-sea exploration where light is scarce. She immediately began preparing a detailed documentation of her findings, knowing its publication would dramatically alter the scientific establishment.",
            "The annual Great Balloon Race took place every June. Competitors from around the world gathered in the central meadow, preparing their massive, colorful airships. This year's favorite, Captain Elara, checked her ropes with intense concentration. Her primary competitor, the notoriously arrogant Lord Vex, watched her from his magnificent, custom-built balloon, determined to sabotage her success through calculated maneuvering. The immense crowd waited in anticipation for the starting cannon to fire.",
            "Eliza, the chief archaeologist, discovered an extraordinary artifact deep within the Egyptian tomb. It was a shimmering, three-dimensional map displaying constellations that scientists believed were impossible to observe from Earth. She felt immense responsibility for the discovery's preservation. Despite immense pressure from rival institutions, she maintained her meticulous documentation, determined to complete the deciphering without interruption. Her meticulous nature proved essential to understanding the complex astronomical configuration.",
        ];

        const comprehensionTips = `
            <h4 class="font-bold text-gray-900">1. Focus on the Main Idea:</h4>
            <p>Encourage Akash to pause after every paragraph or section and verbally summarize the main point. If he can't, re-read that section together to reinforce understanding.</p>

            <h4 class="font-bold text-gray-900">2. Ask the 'W' Questions:</h4>
            <p>Before, during, and after reading, ask: **Who** is the story about? **What** happened? **Where** did it take place? **Why** did the character do that? **When** did it happen? This ensures comprehension of key details.</p>

            <h4 class="font-bold text-gray-900">3. Visualize the Text:</h4>
            <p>Suggest he draw a quick sketch or picture in his mind of what he is reading. This helps turn abstract words into concrete images, strengthening memory and overall understanding.</p>

            <h4 class="font-bold text-gray-900">4. Contextual Clues:</h4>
            <p>If he encounters a hard word, remind him to look at the words around it to guess the meaning. This is a crucial skill for independent reading.</p>
        `;

        // --- Prompts for Analysis APIs ---
        const READING_ANALYSIS_PROMPT = (passageText) => `You are an expert reading coach for a parent. The user has provided an audio file of a child reading a passage and the text of the passage.
Analyze the audio and provide a brief, encouraging report in Markdown format.
Identify:
1.  An estimated Reading Speed (Words Per Minute).
2.  An estimated Accuracy (percentage).
3.  Note any specific words the child hesitated on or mispronounced (e.g., "Hesitation on 'horizon'").
4.  Provide one simple, positive tip for improvement.
Keep the tone supportive and positive.

**Passage Text:**
"${passageText}"

**Analysis Report:**`;

        const COMPREHENSION_ANALYSIS_PROMPT = (givenPassage, studentResponse) => `You are an expert reading comprehension coach for a parent. The user has provided a source passage and a student's written response.
Analyze the student's response based *only* on the given passage.
Provide a brief, encouraging report in Markdown format.
Identify:
1.  A comprehension score (e.g., 8/10).
2.  What the student understood well (e.g., "Correctly identified the main idea").
3.  What they might have missed.
4.  Keep it supportive and address the parent ("Akash did well...").

**Source Passage:**
"${givenPassage}"

**Student's Response:**
"${studentResponse}"

**Analysis Report:**`;

        const COMPREHENSION_IMAGE_ANALYSIS_PROMPT = (givenPassage) => `You are an expert reading comprehension coach for a parent. The user has provided a source passage and an *image* of a student's handwritten response.
Analyze the handwritten response in the image based *only* on the given source passage.
Provide a brief, encouraging report in Markdown format.
Identify:
1.  A comprehension score (e.g., 8/10).
2.  What the student understood well (e.g., "Correctly identified the main idea").
3.  What they might have missed.
4.  Keep it supportive and address the parent ("Akash did well...").

**Source Passage:**
"${givenPassage}"

**Analysis Report (based on the image):**`;


        // --- Helper functions for file/blob reading ---
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64Data = reader.result.split(',')[1];
                    resolve(base64Data);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function fileToDataURL(file) {
            return new Promise((resolve, reject) => {
                if (!file.type.startsWith('image/')) {
                    reject(new Error("File is not an image."));
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    resolve(e.target.result);
                };
                reader.onerror = (e) => {
                    reject(new Error("Failed to read file."));
                };
                reader.readAsDataURL(file);
            });
        }
        
        function fileToMimeAndData(file) {
            return new Promise((resolve, reject) => {
                if (!file.type.startsWith('image/')) {
                    reject(new Error("File is not an image. Please upload a PNG or JPEG."));
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const dataUrl = e.target.result;
                    const parts = dataUrl.split(',');
                    const mimeType = parts[0].split(':')[1].split(';')[0];
                    const base64Data = parts[1];
                    resolve({ mimeType, data: base64Data });
                };
                reader.onerror = (e) => {
                    reject(new Error("Failed to read file."));
                };
                reader.readAsDataURL(file);
            });
        }


        // --- Navigation ---
        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            
            // Update nav link styles
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.getAttribute('data-page') === pageId) {
                    link.classList.remove('inactive');
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                    link.classList.add('inactive');
                }
            });

            if (targetPage) {
                targetPage.classList.add('active');
            } else { 
                console.error("Target page not found:", pageId);
                document.getElementById('page-home').classList.add('active'); // Default to home
            }

            // Setup assessment pages if navigating to them
            if (pageId === 'page-assessment-reading') setupReadingAssessmentPage();
            else if (pageId === 'page-assessment-comprehension') setupComprehensionAssessmentPage();
        }

        // --- Chart/Progress functions ---
        function renderSkillProgress() {
            const container = document.getElementById('skill-progress-bars');
            if (!container) return;

            const skills = [
                { name: 'Reading Fluency', progress: 85, color: 'blue-500' },
                { name: 'Comprehension', progress: 80, color: 'violet-500' },
                { name: 'Vocabulary', progress: 90, color: 'amber-500' },
                { name: 'Pronunciation', progress: 92, color: 'green-500' }
            ];

            container.innerHTML = skills.map(skill => `
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700">${skill.name}</span>
                        <span class="text-sm font-medium text-gray-500">${skill.progress}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-${skill.color} h-2 rounded-full" style="width: ${skill.progress}%"></div>
                    </div>
                </div>
            `).join('');
        }

        function renderSubjectChart() {
            const ctx = document.getElementById('subjectChart');
            if (!ctx) return;

            const gridColor = document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            if (subjectChart) {
                subjectChart.destroy();
            }

            subjectChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Minutes',
                        data: [45, 30, 55, 40, 60, 25, 40],
                        backgroundColor: 'rgba(56, 189, 248, 0.6)', // sky-400 with opacity
                        borderColor: 'rgba(56, 189, 248, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#0f172a',
                            titleColor: '#f8fafc',
                            bodyColor: '#cbd5e1',
                            displayColors: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor },
                            ticks: { color: 'var(--text-muted)' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: 'var(--text-muted)' }
                        }
                    }
                }
            });
        }
        
        const toast = document.getElementById('toast-notification'); 
        const toastMessage = document.getElementById('toast-message'); 
        function showToast(message, type = 'info') { 
            toastMessage.textContent = message; 
            toast.className = 'toast-notification'; 
            void toast.offsetWidth; 
            if (type === 'success') toast.classList.add('bg-green-600'); 
            else if (type === 'error') toast.classList.add('bg-red-600'); 
            else toast.classList.add('bg-blue-600'); 
            toast.classList.add('show'); 
            setTimeout(() => toast.classList.remove('show'), 3000); 
        }

        // --- Assessment Page Setup Functions ---
        function setupReadingAssessmentPage() { 
            const passageElement = document.getElementById('reading-passage'); 
            if(passageElement){ 
                const randomIndex = Math.floor(Math.random() * readingPassages.length); 
                passageElement.textContent = readingPassages[randomIndex]; 
            } 
            resetRecordingState(); 
            const resultsDiv = document.getElementById('reading-assessment-results'); 
            if(resultsDiv) resultsDiv.classList.add('hidden'); 
        }
        
        function setupComprehensionAssessmentPage() { 
            selectedComprehensionFile = null; 
            const comprehensionInput = document.getElementById('comprehension-written-response');
            if (comprehensionInput) comprehensionInput.value = '';

            const passageElement = document.getElementById('comprehension-given-passage');
            if(passageElement) {
                const randomIndex = Math.floor(Math.random() * comprehensionPassages.length);
                passageElement.textContent = comprehensionPassages[randomIndex];
            }
            
            // Set default mode to 'upload'
            setComprehensionMode('upload');
            
            const resultsDiv = document.getElementById('comprehension-assessment-results'); 
            if(resultsDiv) resultsDiv.classList.add('hidden'); 
            
            const submitBtn = document.getElementById('start-comprehension-btn');
            if(submitBtn) {
                submitBtn.disabled = true;
                submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                submitBtn.classList.remove('bg-accent', 'hover:bg-accent-dark');
            }
        }

        function setComprehensionMode(mode) {
            currentComprehensionMode = mode;
            const inputArea = document.getElementById('comprehension-input-area');
            const uploadBtn = document.getElementById('mode-upload-btn');
            const writeBtn = document.getElementById('mode-write-btn');
            const dyslexiaCheck = document.getElementById('dyslexia-check-container');

            if (!inputArea || !uploadBtn || !writeBtn || !dyslexiaCheck) return;

            if (mode === 'upload') {
                uploadBtn.classList.replace('inactive', 'active');
                writeBtn.classList.replace('active', 'inactive');
                dyslexiaCheck.classList.remove('hidden');
                
                inputArea.innerHTML = `
                    <label for="comprehension-file-input" class="file-input-button w-full">
                        <ion-icon name="cloud-upload-outline" class="text-xl"></ion-icon>
                        <span id="comprehension-file-name">Click to Upload Image (PNG, JPG)</span>
                        <input id="comprehension-file-input" type="file" class="hidden" accept="image/png, image/jpeg" onchange="handleComprehensionFileSelect(event)">
                    </label>
                    <p class="text-xs text-gray-500 mt-2">Please upload a clear image of the handwritten response.</p>
                    <div id="comprehension-image-preview" class="mt-4 hidden max-h-48 overflow-hidden rounded-lg border">
                        <img id="preview-image-src" src="#" alt="Image preview" class="w-full h-auto object-cover">
                    </div>
                `;
            } else { // mode === 'write'
                uploadBtn.classList.replace('active', 'inactive');
                writeBtn.classList.replace('inactive', 'active');
                dyslexiaCheck.classList.add('hidden');

                inputArea.innerHTML = `
                    <label for="comprehension-written-response" class="block text-sm font-medium text-gray-900 mb-1">Written Response:</label>
                    <textarea id="comprehension-written-response" rows="8" placeholder="Type Akash's response to the passage here..." class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-accent focus:border-accent resize-vertical" oninput="validateComprehensionInput()"></textarea>
                    <p id="comprehension-word-count" class="text-xs text-gray-500 mt-1">0 words (Minimum ${MIN_COMPREHENSION_WORDS} required)</p>
                `;
            }
            // Reset validation after mode switch
            validateComprehensionInput();
        }

        function handleComprehensionFileSelect(event) {
            const file = event.target.files[0];
            const fileNameEl = document.getElementById('comprehension-file-name');
            const previewContainer = document.getElementById('comprehension-image-preview');
            const previewImg = document.getElementById('preview-image-src');

            if (file && file.type.startsWith('image/')) {
                selectedComprehensionFile = file;
                fileNameEl.textContent = file.name;
                
                fileToDataURL(file).then(dataUrl => {
                    previewImg.src = dataUrl;
                    previewContainer.classList.remove('hidden');
                }).catch(err => {
                    console.error(err);
                    showToast(err.message, 'error');
                });

            } else {
                selectedComprehensionFile = null;
                fileNameEl.textContent = 'Click to Upload Image (PNG, JPG)';
                previewContainer.classList.add('hidden');
                previewImg.src = "#";
                if(file) { // if a file was selected but it wasn't an image
                    showToast('Invalid file type. Please select a PNG or JPG image.', 'error');
                }
            }
            validateComprehensionInput();
        }

        function validateComprehensionInput() {
            const submitBtn = document.getElementById('start-comprehension-btn');
            if (!submitBtn) return;

            let isValid = false;
            if (currentComprehensionMode === 'upload') {
                isValid = selectedComprehensionFile != null;
            } else { // mode === 'write'
                const textArea = document.getElementById('comprehension-written-response');
                if (textArea) {
                    const wordCount = textArea.value.trim().split(/\s+/).filter(Boolean).length;
                    document.getElementById('comprehension-word-count').textContent = `${wordCount} words (Minimum ${MIN_COMPREHENSION_WORDS} required)`;
                    isValid = wordCount >= MIN_COMPREHENSION_WORDS;
                }
            }

            if (isValid) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                submitBtn.classList.add('bg-accent', 'hover:bg-accent-dark');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                submitBtn.classList.remove('bg-accent', 'hover:bg-accent-dark');
            }
        }


        // --- Reading Assessment (Recording) ---
        function resetRecordingState() {
            document.getElementById('start-record-btn').classList.remove('hidden');
            document.getElementById('pause-record-btn').classList.add('hidden');
            document.getElementById('resume-record-btn').classList.add('hidden');
            document.getElementById('stop-record-btn').classList.add('hidden');
            document.getElementById('recording-status').innerHTML = '';
            audioChunks = [];
            audioBlob = null;
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                mediaRecorder.onstop = handleStopRecording;
                
                mediaRecorder.start();
                
                document.getElementById('start-record-btn').classList.add('hidden');
                document.getElementById('pause-record-btn').classList.remove('hidden');
                document.getElementById('stop-record-btn').classList.remove('hidden');
                document.getElementById('recording-status').innerHTML = '<span class="recording-dot"></span> Recording...';
                showToast('Recording started!', 'info');
            } catch (err) {
                console.error("Error starting recording:", err);
                showToast('Could not start recording. Please check microphone permissions.', 'error');
                document.getElementById('recording-status').innerHTML = '<span class="text-red-500">Mic access denied.</span>';
            }
        }

        function pauseRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.pause();
                document.getElementById('pause-record-btn').classList.add('hidden');
                document.getElementById('resume-record-btn').classList.remove('hidden');
                document.getElementById('recording-status').innerHTML = 'Paused';
            }
        }

        function resumeRecording() {
            if (mediaRecorder && mediaRecorder.state === 'paused') {
                mediaRecorder.resume();
                document.getElementById('pause-record-btn').classList.remove('hidden');
                document.getElementById('resume-record-btn').classList.add('hidden');
                document.getElementById('recording-status').innerHTML = '<span class="recording-dot"></span> Recording...';
            }
        }

        function stopRecording() {
            if (mediaRecorder && (mediaRecorder.state === 'recording' || mediaRecorder.state === 'paused')) {
                mediaRecorder.stop();
                document.getElementById('recording-status').innerHTML = 'Processing...';
                // The onstop event will handle the rest
            }
        }

        async function handleStopRecording() {
            audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            // Stop all media tracks to turn off the mic indicator
            if (mediaRecorder.stream) {
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            resetRecordingState();
            showToast('Recording stopped. Analyzing...', 'info');

            // --- AI Analysis ---
            const resultsDiv = document.getElementById('reading-assessment-results');
            resultsDiv.classList.remove('hidden');
            resultsDiv.innerHTML = `<p class="font-medium text-gray-800 mb-1">Analyzing audio...</p><p>This may take a moment. The AI is calculating reading speed and accuracy.</p>`;

            try {
                // 1. Get base64 audio data
                const base64Audio = await blobToBase64(audioBlob);
                
                // 2. Prepare API call
                const passageText = document.getElementById('reading-passage').textContent;
                const prompt = READING_ANALYSIS_PROMPT(passageText);
                const audioFileData = {
                    mimeType: audioBlob.type,
                    data: base64Audio
                };

                // 3. Call Gemini API
                const analysisResult = await callGeminiAPI(prompt, audioFileData);

                // 4. Display results
                resultsDiv.innerHTML = renderMarkdown(analysisResult);
                showToast('Reading analysis complete!', 'success');

            } catch (error) {
                console.error("Error during reading analysis:", error);
                resultsDiv.innerHTML = `<p class="font-medium text-red-600 mb-1">Analysis Failed</p><p>Could not analyze the audio. Please try again. (${error.message})</p>`;
                showToast('Analysis failed.', 'error');
            }
        }


        // --- Comprehension Assessment ---
        async function startComprehensionAssessment() {
            const submitBtn = document.getElementById('start-comprehension-btn');
            const resultsDiv = document.getElementById('comprehension-assessment-results');
            const givenPassage = document.getElementById('comprehension-given-passage').textContent;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<ion-icon name="sync-outline" class="text-xl animate-spin"></ion-icon> Analyzing...`;
            resultsDiv.classList.remove('hidden');
            resultsDiv.innerHTML = `<p class="font-medium text-gray-800 mb-1">Analyzing response...</p><p>This may take a moment. The AI is evaluating comprehension and structure.</p>`;

            let comprehensionReport = "";
            let dyslexiaReport = "";
            let combinedReport = "";

            try {
                if (currentComprehensionMode === 'write') {
                    // --- Text-based analysis ---
                    const studentResponse = document.getElementById('comprehension-written-response').value;
                    const prompt = COMPREHENSION_ANALYSIS_PROMPT(givenPassage, studentResponse);
                    
                    comprehensionReport = await callGeminiAPI(prompt, null);
                    combinedReport = comprehensionReport;

                } else {
                    // --- Image-based analysis ---
                    if (!selectedComprehensionFile) {
                        throw new Error("No image file selected.");
                    }
                    
                    const { mimeType, data: base64Image } = await fileToMimeAndData(selectedComprehensionFile);
                    const imageFileData = { mimeType, data: base64Image };
                    
                    // 1. Call Gemini for Comprehension
                    const comprehensionPrompt = COMPREHENSION_IMAGE_ANALYSIS_PROMPT(givenPassage);
                    comprehensionReport = await callGeminiAPI(comprehensionPrompt, imageFileData);
                    combinedReport = comprehensionReport;

                    // 2. Check for Dyslexia Analysis
                    const dyslexiaCheck = document.getElementById('dyslexia-check');
                    if (dyslexiaCheck && dyslexiaCheck.checked) {
                        resultsDiv.innerHTML += `<p class="font-medium text-gray-800 mt-4 mb-1">Analyzing handwriting for dyslexic traits...</p>`;
                        
                        try {
                            dyslexiaReport = await callHuggingFaceAPI(base64Image);
                            combinedReport += `
<hr style="margin: 1rem 0; border-color: var(--border-color);">
<h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Handwriting Analysis (Beta)</h3>
${dyslexiaReport}
<p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;"><i>Note: This analysis is experimental and not a medical diagnosis. Consult a specialist for a formal assessment.</i></p>
`;
                        } catch (hfError) {
                            console.error("Hugging Face API Error:", hfError);
                            dyslexiaReport = `<p style="color: var(--text-secondary);">Handwriting analysis failed: ${hfError.message}</p>`;
                            combinedReport += `
<hr style="margin: 1rem 0; border-color: var(--border-color);">
<h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Handwriting Analysis (Beta)</h3>
${dyslexiaReport}
`;
                        }
                    }
                }
                
                // 4. Display final combined report
                resultsDiv.innerHTML = renderMarkdown(combinedReport);
                showToast('Comprehension analysis complete!', 'success');

            } catch (error) {
                console.error("Error during comprehension analysis:", error);
                resultsDiv.innerHTML = `<p class="font-medium text-red-600 mb-1">Analysis Failed</p><p>Could not analyze the response. Please try again. (${error.message})</p>`;
                showToast('Analysis failed.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = `<ion-icon name="play-circle-outline" class="text-xl"></ion-icon> Submit Response for Assessment`;
                validateComprehensionInput(); // Re-validate to set button state
            }
        }


        // --- AI API Callers ---
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key="; // Key is empty
        const API_KEY = ""; // Kept empty as per instructions

        async function callGeminiAPI(prompt, fileData) {
            console.log("Calling Gemini API...");
            const apiUrl = `${GEMINI_API_URL}${API_KEY}`;
            
            let parts = [{ text: prompt }];
            if (fileData && fileData.data) {
                parts.push({
                    inlineData: {
                        mimeType: fileData.mimeType,
                        data: fileData.data
                    }
                });
            }

            const payload = {
                contents: [{ role: "user", parts: parts }]
            };

            // Exponential backoff
            let response;
            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; // Success
                    }
                    if (response.status === 429) { // Throttling
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                        continue;
                    }
                    // Other non-retriable error
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);

                } catch (error) {
                    if (i === 4) { // Last retry failed
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }

            if (!response || !response.ok) {
                throw new Error(`API request failed after retries: ${response.status} ${response.statusText}`);
            }

            const result = await response.json();
            
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0 &&
                result.candidates[0].content.parts[0].text) {
                
                return result.candidates[0].content.parts[0].text;
            } else {
                console.error("Invalid response structure from Gemini:", result);
                if(result.promptFeedback) {
                    throw new Error(`API call blocked. Reason: ${result.promptFeedback.blockReason}`);
                }
                throw new Error("Invalid response structure from Gemini API.");
            }
        }
        
        async function callHuggingFaceAPI(base64ImageData) {
            console.log("Calling Hugging Face API for dyslexia check...");
            
            // The HF API expects the image data in a specific data URL format
            const dataUrl = `data:image/jpeg;base64,${base64ImageData}`;

            const payload = {
                data: [dataUrl]
            };

            // Exponential backoff
            let response;
            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    response = await fetch(HUGGINGFACE_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; // Success
                    }
                    // Note: HF Spaces might not return 429, they might just fail or time out
                    // We'll retry on any non-OK status for this example
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;

                } catch (error) {
                    if (i === 4) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
            
            if (!response || !response.ok) {
                throw new Error(`Hugging Face API request failed after retries. Status: ${response?.status}`);
            }

            const result = await response.json();

            if (result && result.data && result.data.length > 0) {
                const analysis = result.data[0];
                // Assuming the API returns a 'label' (e.g., "Healthy", "Dyslexic") 
                // and a 'confidences' array
                if (analysis.label && analysis.confidences) {
                    const confidenceScore = analysis.confidences.find(c => c.label === analysis.label)?.confidence;
                    let reportText = `**Finding:** The handwriting shows traits associated with **${analysis.label}**.`;
                    if(confidenceScore) {
                         reportText += ` (Confidence: ${Math.round(confidenceScore * 100)}%)`;
                    }
                    return reportText;
                } else if (typeof analysis === 'string') {
                    // Sometimes HF endpoints just return a string
                    return analysis;
                }
                 else {
                    // Fallback if structure is unknown
                    return `Analysis complete. Result: ${JSON.stringify(analysis)}`;
                }
            } else {
                throw new Error("Invalid response structure from Hugging Face API.");
            }
        }


        // --- Other Page Handlers ---
        function handleLogout() {
            document.getElementById('logout-modal').classList.add('hidden');
            showToast('Logged out successfully!', 'success');
            // In a real app, you'd redirect or clear session data here.
            // For this demo, we'll just go back to the home page.
            navigateTo('page-home');
        }

        function handleGenerateReport() {
            const reportTypeSelect = document.getElementById('report-type');
            const reportRangeSelect = document.getElementById('report-range');

            if (!reportTypeSelect || !reportRangeSelect) {
                showToast('Error: Report elements not found.', 'error');
                return;
            }

            const reportType = reportTypeSelect.value;
            const reportRange = reportRangeSelect.value;
            
            const modal = document.getElementById('report-modal');
            const title = document.getElementById('report-modal-title');
            const content = document.getElementById('report-content');
            
            title.textContent = `${reportType} (${reportRange})`;
            content.innerHTML = `
                <p class="font-semibold text-gray-900 mb-2">AI-Generated Summary for Akash (${reportRange}):</p>
                <p class="mb-2">This is a simulated report for the "${reportType}".</p>
                <p class="mb-2"><strong>Overall Performance:</strong> Excellent</p>
                <p class="mb-2">Akash has shown significant improvement, particularly in Reading Fluency, which increased by 12% over this period. Comprehension remains strong at 85%.</p>
                <ul class="list-disc list-inside mb-2">
                    <li><strong>Words Per Minute:</strong> 88 WPM (Up from 82 WPM)</li>
                    <li><strong>Accuracy:</strong> 95% (Stable)</li>
                    <li><strong>Areas to Focus:</strong> Continue practice with multi-syllabic words.</li>
                </ul>
                <p>Keep up the great work!</p>
            `;
            modal.classList.remove('hidden');
        }
        
        function handleReportDownload(type, range) {
            if (type !== 'Weekly Summary') {
                showToast('Only "Weekly Summary" download is enabled for this demo.', 'error');
                return;
            }
            showToast(`Downloading "Weekly Summary (${range})..."`, 'success');
            // In a real app, this would trigger a file download.
        }

        function handleFindPassages() {
            const modal = document.getElementById('report-modal');
            const title = document.getElementById('report-modal-title');
            const content = document.getElementById('report-content');
            
            title.textContent = `AI-Generated Passages`;
            content.innerHTML = `
                <p class="font-semibold text-gray-900 mb-2">Recommended Reading Passages:</p>
                <p class="mb-3">Here are two passages with complex sentences, as requested:</p>
                
                <div class="p-3 bg-gray-100 rounded-lg border mb-3">
                    <h4 class="font-semibold text-gray-800">Passage 1: The Mountain</h4>
                    <p>The ancient mountain, which had stood for millennia, cast a long shadow over the valley, where villagers had built their homes from the very stone that crumbled from its peaks.</p>
                </div>
                <div class="p-3 bg-gray-100 rounded-lg border">
                    <h4 class="font-semibold text-gray-800">Passage 2: The Inventor</h4>
                    <p>Elara, an inventor known for her peculiar gadgets, worked tirelessly in her workshop, determined to finish the mechanical bird before the annual fair commenced.</p>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        function handleViewTips() {
            const modal = document.getElementById('recommended-tips-modal');
            const content = document.getElementById('tips-modal-content');
            content.innerHTML = comprehensionTips; // Assuming comprehensionTips is defined
            modal.classList.remove('hidden');
        }

        function handleGenerateContent() {
            const btn = document.getElementById('generate-content-btn');
            const contentType = document.getElementById('content-type-selector').value;
            const prompt = document.getElementById('generator-prompt').value;
            const resultsDiv = document.getElementById('generated-content-results');
            const initialMsg = document.getElementById('initial-message');

            if (prompt.length < 10) {
                showToast('Please enter a topic or prompt (at least 10 characters).', 'error');
                return;
            }
            
            // --- UI Updates ---
            btn.disabled = true;
            btn.innerHTML = `<ion-icon name="sync-outline" class="text-xl animate-spin"></ion-icon> Generating...`;
            initialMsg.classList.add('hidden');
            resultsDiv.classList.remove('hidden');
            resultsDiv.innerHTML = `<div class="p-6 bg-white rounded-xl shadow-md text-gray-600"><p class="font-medium text-gray-800 mb-1">Generating ${contentType} for "${prompt}"...</p><p>This may take a moment. The AI is crafting the content.</p></div>`;

            // --- AI Call ---
            // We create a specific prompt for the Gemini API
            const generatorSystemPrompt = `You are an AI curriculum helper for a parent. You need to generate a specific type of learning material for their child, Akash.
The parent has requested:
- Content Type: ${contentType}
- Topic/Prompt: ${prompt}

Generate a short, clear, and encouraging piece of content based *only* on this request. Use simple Markdown for formatting (headings, lists, bold).
Address the parent directly, e.g., "Here is the ${contentType} for Akash."`;
            
            callGeminiAPI(generatorSystemPrompt, null)
                .then(aiResponse => {
                    resultsDiv.innerHTML = `
                        <div class="p-6 bg-white rounded-xl shadow-md">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">${contentType} (AI-Generated)</h3>
                            ${renderMarkdown(aiResponse)}
                        </div>`;
                    showToast('Content generated successfully!', 'success');
                })
                .catch(error => {
                    console.error("Error generating content:", error);
                    resultsDiv.innerHTML = `
                        <div class="p-6 bg-white rounded-xl shadow-md">
                            <h3 class="text-lg font-semibold text-red-600 mb-3">Error Generating Content</h3>
                            <p class="text-gray-700">Sorry, there was an error: ${error.message}. Please try again.</p>
                        </div>`;
                    showToast('Error generating content.', 'error');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = `<ion-icon name="sparkles-outline" class="text-xl"></ion-icon> Generate Content`;
                });
        }
        
        // --- Chat Widget ---
        let isChatOpen = false;
        const chatWidget = document.getElementById('chat-widget');
        const fabContainer = document.getElementById('fab-container');
        
        function toggleChat() {
            isChatOpen = !isChatOpen;
            if (isChatOpen) {
                chatWidget.classList.remove('hidden');
                chatWidget.classList.add('flex');
                // Hide FABs when chat is open
                fabContainer.classList.add('hidden');
            } else {
                chatWidget.classList.add('hidden');
                chatWidget.classList.remove('flex');
                // Show FABs when chat is closed (if they were supposed to be visible)
                if (document.getElementById('page-home').classList.contains('active')) {
                     fabContainer.classList.remove('hidden');
                }
            }
        }
        
        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const chatInput = document.getElementById('chat-input');
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            addMessageToChat(userMessage, 'user');
            chatInput.value = '';
            
            // Add thinking indicator
            const thinkingId = 'thinking-' + Date.now();
            addMessageToChat('Boo is thinking...', 'ai', thinkingId);

            try {
                // Construct a prompt for the chatbot
                const prompt = `You are Boo, an AI assistant for a parent named ${currentUserName}. You are helping them understand their child's (Akash) reading and comprehension progress on the "SoundSlate" platform. Be helpful, concise, and encouraging.
                
                User question: "${userMessage}"`;

                const aiResponse = await callGeminiAPI(prompt, null);
                
                // Update or replace thinking message
                const thinkingBubble = document.getElementById(thinkingId);
                if(thinkingBubble) {
                    thinkingBubble.innerHTML = renderMarkdown(aiResponse); // Use renderMarkdown
                    thinkingBubble.classList.remove('thinking');
                } else {
                    addMessageToChat(aiResponse, 'ai');
                }

            } catch (error) {
                console.error("Error in chatbot:", error);
                // Update or replace thinking message with an error
                const thinkingBubble = document.getElementById(thinkingId);
                const errorMessage = "Sorry, I'm having trouble connecting right now. Please try again in a moment.";
                if(thinkingBubble) {
                    thinkingBubble.textContent = errorMessage;
                    thinkingBubble.classList.remove('thinking');
                } else {
                    addMessageToChat(errorMessage, 'ai');
                }
            }
        });

        function addMessageToChat(message, sender, id = null) {
            const chatMessages = document.getElementById('chat-messages');
            const wrapper = document.createElement('div');
            wrapper.classList.add('flex', sender === 'user' ? 'justify-end' : 'justify-start');
            
            const messageEl = document.createElement('div');
            messageEl.classList.add('chat-bubble', `chat-bubble-${sender}`);
            if(id) messageEl.id = id;
            if(sender === 'ai' && message.includes('thinking')) messageEl.classList.add('thinking');
            
            // Use renderMarkdown for AI messages, but not for "thinking"
            if (sender === 'ai' && !message.includes('thinking')) {
                messageEl.innerHTML = renderMarkdown(message);
            } else {
                messageEl.textContent = message;
            }
            
            wrapper.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // --- Markdown Renderer ---
        function renderMarkdown(text) {
            if (!text) return '';
            
            // A simple pseudo-markdown renderer for the demo
            // Note: This is NOT a full or secure markdown parser, just for this app's specific output.
            
            // Process headings (e.g., ### Heading)
            let html = text.replace(/^### (.*$)/gim, '<h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.75rem;">$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1 style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 1rem;">$1</h1>');

            // Process bold (**text**)
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong style="font-weight: 600; color: var(--text-primary);">$1</strong>');
            
            // Process lists (* item)
            html = html.replace(/^\* (.*$)/gim, '<li style="margin-left: 1.5rem; list-style-type: disc; margin-bottom: 0.25rem;">$1</li>');
            html = html.replace(/<\/li>\n<li/g, '</li><li'); // Fix newlines between list items
            html = html.replace(/^(<li.*<\/li>)/gms, '<ul style="padding-left: 0.5rem; margin-bottom: 1rem;">$1</ul>'); // Wrap lists in <ul>
            
             // Process numbered lists (1. item)
            html = html.replace(/^(\d+)\. (.*$)/gim, '<li style="margin-left: 1.5rem; list-style-type: decimal; margin-bottom: 0.25rem;" value="$1">$2</li>');
            html = html.replace(/<\/li>\n<li/g, '</li><li'); // Fix newlines
            html = html.replace(/^(<li.*<\/li>)/gms, '<ol style="padding-left: 0.5rem; margin-bottom: 1rem;">$1</ol>'); // Wrap lists in <ol>

            // Process paragraphs (split by newlines)
            html = html.split(/\n\n+/).map(paragraph => {
                if (paragraph.startsWith('<ul') || paragraph.startsWith('<ol') || paragraph.startsWith('<h')) {
                    return paragraph; // Don't wrap lists or headings in <p>
                }
                // Handle paragraphs that might just be newlines
                const trimmedParagraph = paragraph.trim();
                if (!trimmedParagraph) return '';
                
                // Replace single newlines within a paragraph with a space, not <br>
                return `<p style="margin-bottom: 0.75rem; color: var(--text-secondary);">${trimmedParagraph.replace(/\n/g, ' ')}</p>`;
            }).join('');
            
            // Clean up empty paragraphs
            html = html.replace(/<p>\s*<\/p>/g, '');
            // Fix paragraphs that were incorrectly joined
            html = html.replace(/<\/p><p>/g, '</p>\n<p>');

            return html;
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set initial user name (example)
            currentUserName = "Abhishek"; 
            document.getElementById('welcome-banner').textContent = `Welcome back, ${currentUserName}!`;
            document.getElementById('progress-welcome').textContent = `Hi ${currentUserName}!`;
            document.querySelectorAll('[id^="user-name-"]').forEach(el => el.textContent = `Hi, ${currentUserName}!`);
            document.querySelectorAll('[id^="user-avatar-"]').forEach(el => el.textContent = currentUserName.charAt(0));

            // Set up theme toggle
            const themeToggle = document.getElementById('theme-toggle');
            if (localStorage.getItem('theme') === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggle.checked = true;
            } else {
                document.documentElement.classList.remove('dark');
                themeToggle.checked = false;
            }
            themeToggle.addEventListener('change', () => {
                if (themeToggle.checked) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
                // Redraw chart if on progress page
                if (document.getElementById('page-progress').classList.contains('active')) {
                    renderSubjectChart();
                }
            });

            // Initial page setup
            navigateTo('page-home');
            
            // Render charts/data for pages that need it
            renderSkillProgress();
            renderSubjectChart();
            
            // Show FABs on home page
            fabContainer.classList.remove('hidden');
        });

        // Handle notification dropdown
        let isNotificationOpen = false;
        function toggleNotificationDropdown(event) {
            event.stopPropagation();
            const modal = document.getElementById('notification-modal');
            modal.classList.toggle('hidden');
            isNotificationOpen = !modal.classList.contains('hidden');
        }

        // Close dropdowns if clicking outside
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('notification-modal');
            if (!modal.classList.contains('hidden') && !modal.firstElementChild.contains(e.target)) {
                 // Check if the click was outside the modal's content
                modal.classList.add('hidden');
                isNotificationOpen = false;
            }
        });

    </script>
</body>
</html>


